# خطة الاختبار — منصة فكرة

خطة موحّدة لاختبار المنصة: وحدة، تكامل، E2E، وقبول يدوي.  
**المرجع السريع:** [TESTING.md](./TESTING.md) | [MANUAL_TESTING.md](./MANUAL_TESTING.md) | [FIREBASE_ACCEPTANCE_TESTS.md](./FIREBASE_ACCEPTANCE_TESTS.md)

---

## 1. الهدف من الخطة

- ضمان عمل المسارات والميزات الأساسية بعد أي تغيير.
- تغطية تسجيل الدخول، الطلبات، المحادثة، المخططات، والإدارة.
- ربط الاختبار الآلي باختبارات قبول Firebase عند التنفيذ.

---

## 2. البنية الحالية للاختبار

| النوع | الأداة | الملفات/المجلد | الأمر |
|--------|--------|------------------|--------|
| وحدة | Vitest | `lib/utils.test.ts`, `lib/sanitize.test.ts` | `npm run test` / `npm run test:run` |
| E2E | Playwright | `e2e/homepage.spec.ts` | `npm run test:e2e` |
| قبول يدوي | — | [MANUAL_TESTING.md](./MANUAL_TESTING.md) | تنفيذ يدوي |
| قبول Firebase | — | FIREBASE_ACCEPTANCE_TESTS.md | حسب المرحلة |

---

## 3. خطة التنفيذ (أولويات)

### المرحلة أ: تثبيت وتشغيل (التحقق من البيئة)

- [ ] تشغيل `npm install` و`npm run build` بنجاح.
- [ ] تشغيل `npm run test:run` — كل اختبارات Vitest تمر.
- [ ] تشغيل `npm run test:e2e` — اختبار الصفحة الرئيسية يمر (السيرفر يُشغّل تلقائياً).
- [ ] تشغيل `npm run dev` وفتح `http://localhost:3000` — الصفحة الرئيسية تُعرض دون أخطاء في الكونسول.

**النتيجة المتوقعة:** بيئة الاختبار جاهزة والاختبارات الحالية خضراء.

---

### المرحلة ب: توسيع E2E (الصفحات العامة والمصادقة)

الهدف: أتمتة مسارات أساسية بدون تعقيد تسجيل الدخول أولاً.

- [ ] **الصفحة الرئيسية (موجود):** التأكد من أن `e2e/homepage.spec.ts` يمر.
- [ ] **صفحة تسجيل الدخول:**
  - فتح `/login`.
  - ظهور حقول البريد وكلمة المرور وزر "تسجيل الدخول".
- [ ] **صفحة التسجيل:** فتح `/register` وظهور النموذج.
- [ ] **(اختياري)** تسجيل دخول بـ `client@test.com` / `password123` والتحقق من إعادة التوجيه إلى `/dashboard`.

**ملفات مقترحة:**  
- `e2e/auth.spec.ts` (وصف تسجيل الدخول/التسجيل بدون أو مع بيانات ثابتة).

**النتيجة المتوقعة:** E2E يغطي الرئيسية + صفحات المصادقة.

---

### المرحلة ج: E2E لمسارات العميل (بعد تسجيل الدخول)

استخدام حساب تجريبي ثابت (مثل `client@test.com`) أو إعداد state عبر storage.

- [ ] **لوحة تحكم العميل:** بعد تسجيل الدخول، التحقق من ظهور `/dashboard` وعنوان مناسب.
- [ ] **إنشاء طلب:** من لوحة التحكم أو من الصفحة الرئيسية، الدخول إلى إنشاء طلب، اختيار باقة، وإكمال الخطوات حتى إرسال الطلب (أو حتى خطوة معينة حسب استقرار النموذج).
- [ ] **صفحة طلب:** فتح `/orders/[id]` لطلب موجود والتحقق من ظهور المحتوى (تفاصيل، حالة، أزرار).

**ملفات مقترحة:**  
- `e2e/client-dashboard.spec.ts`  
- `e2e/order-create.spec.ts` أو توسيع ملف واحد لمسار "إنشاء طلب".

**النتيجة المتوقعة:** أتمتة مسار عميل من الدخول → لوحة التحكم → إنشاء/عرض طلب.

---

### المرحلة د: اختبارات وحدة إضافية (حسب الحاجة)

- [ ] مراجعة `lib/api.ts` و`lib/auth.ts`: إن وجدت دوال نقية قابلة للاختبار (مثلاً تحويل شكل الاستجابة)، إضافة اختبارات في `lib/api.test.ts` أو ما شابه.
- [ ] الاحتفاظ بـ `lib/utils.test.ts` و`lib/sanitize.test.ts` وتشغيلهما في CI.

**النتيجة المتوقعة:** تغطية وحدة مستقرة للدوال المشتركة.

---

### المرحلة هـ: قائمة التحقق اليدوية (قبل كل إصدار)

تنفيذ يدوي سريع للمسارات الحرجة (يمكن تقليصه حسب الوقت):

- [ ] تسجيل الدخول (عميل، مهندس، مدير) باستخدام الحسابات في README.
- [ ] الصفحة الرئيسية تعرض الباقات دون أخطاء في الكونسول.
- [ ] إنشاء طلب جديد: اختيار باقة → إدخال البيانات → إرسال.
- [ ] لوحة تحكم العميل تعرض الطلبات.
- [ ] لوحة تحكم المهندس تعرض الطلبات (إن وُجدت).
- [ ] فتح طلب → محادثة أو عرض مخطط (حسب توفر بيانات).
- [ ] لوحة الإدارة: عرض الطلبات/الباقات دون خطأ.

**المرجع:** القسم "قائمة تحقق قبول يدوي" في [TESTING.md](./TESTING.md).

---

### المرحلة و: ربط خطة الاختبار بانتقال Firebase

عند تنفيذ مراحل Firebase:

- [ ] قبل كل مرحلة: تشغيل `npm run test:run` و`npm run test:e2e` والتأكد من عدم كسر شيء.
- [ ] بعد كل مرحلة: تنفيذ بنود المرحلة المقابلة في [FIREBASE_ACCEPTANCE_TESTS.md](./FIREBASE_ACCEPTANCE_TESTS.md).
- [ ] المرحلة 7: تنفيذ نفس الاختبارات (وحدة + E2E + يدوي) على الـ URL المنشور.

---

## 4. أوامر سريعة

```bash
# اختبارات وحدة (مرة واحدة، مناسب لـ CI)
npm run test:run

# اختبارات وحدة مع مراقبة
npm run test

# E2E (يشغّل dev تلقائياً إن لزم)
npm run test:e2e

# بناء المشروع (يتحقق من المسارات)
npm run build
```

---

## 5. الخطوة التالية الموصى بها

**لبدء خطة الاختبار فعلياً الآن:**

1. تشغيل **المرحلة أ** كاملة (تثبيت، build، test:run، test:e2e، فتح المتصفح).
2. إذا مرّ كل شيء، إضافة ملف **`e2e/auth.spec.ts`** (المرحلة ب) لاختبار صفحات تسجيل الدخول والتسجيل.
3. بعد ذلك توسيع E2E لمسارات العميل (المرحلة ج) حسب أولوية الميزات.

بعد إكمال المرحلة أ يمكن الرجوع إلى هذا الملف وتنفيذ المراحل التالية بالترتيب.
