generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  password         String
  name             String
  phone            String         @unique
  role             String         @default("CLIENT")
  pushSubscription String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  messages         Message[]      @relation("MessageSender")
  notifications    Notification[]
  clientOrders     Order[]        @relation("ClientOrders")
  engineerOrders   Order[]        @relation("EngineerOrders")

  @@index([email])
  @@index([phone])
  @@index([role])
}

model Package {
  id            String   @id @default(cuid())
  nameAr        String
  nameEn        String?
  price         Float
  revisions     Int      @default(2)
  executionDays Int      @default(7)
  isActive      Boolean  @default(true)
  featuresJson  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  orders        Order[]

  @@index([isActive])
}

model Order {
  id                    String            @id @default(cuid())
  orderNumber           String            @unique
  clientId              String
  engineerId            String?
  packageId             String
  status                String            @default("PENDING")
  formData              String
  remainingRevisions    Int               @default(0)
  deadline              DateTime
  completedAt           DateTime?
  plansPurgedAt         DateTime?
  archivedWarningSentAt DateTime?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  messages              Message[]
  client                User              @relation("ClientOrders", fields: [clientId], references: [id], onDelete: Cascade)
  engineer              User?             @relation("EngineerOrders", fields: [engineerId], references: [id])
  package               Package           @relation(fields: [packageId], references: [id])
  auditLogs             OrderAuditLog[]
  payments              Payment[]
  pinPackPurchases      PinPackPurchase[]
  plans                 Plan[]
  revisionRequests      RevisionRequest[]

  @@index([clientId])
  @@index([engineerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@index([deadline])
  @@index([status, createdAt])
}

model OrderAuditLog {
  id        String   @id @default(cuid())
  orderId   String
  userId    String
  action    String
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
}

model Plan {
  id        String    @id @default(cuid())
  orderId   String
  fileUrl   String
  fileType  String
  fileName  String?
  fileSize  Int?
  isActive  Boolean   @default(true)
  purgedAt  DateTime?
  createdAt DateTime  @default(now())
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([isActive])
}

model Message {
  id        String   @id @default(cuid())
  orderId   String
  senderId  String
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender    User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([senderId])
  @@index([orderId, createdAt])
  @@index([createdAt])
  @@index([isRead])
}

model Payment {
  id            String   @id @default(cuid())
  orderId       String
  amount        Float
  method        String   @default("card")
  status        String   @default("pending")
  transactionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([createdAt])
}

model PaymentIdempotency {
  idempotencyKey String   @unique
  orderId        String
  paymentId      String
  createdAt      DateTime @default(now())

  @@index([idempotencyKey])
  @@index([createdAt])
}

model RevisionRequest {
  id        String   @id @default(cuid())
  orderId   String
  planId    String?
  pins      String
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  data      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model PinPackConfig {
  id                     String   @id @default(cuid())
  pinPackPrice           Float
  pinPackOldPrice        Float?
  pinPackDiscountPercent Float?
  messageWhen1Left       String?
  messageWhen0Left       String?
  updatedAt              DateTime @updatedAt
}

model RevisionsPurchaseConfig {
  id                      String   @id @default(cuid())
  pricePerRevision        Float
  maxRevisionsPerPurchase Int      @default(20)
  updatedAt               DateTime @updatedAt
}

model PinPackPurchase {
  id            String   @id @default(cuid())
  orderId       String
  amount        Float
  status        String   @default("completed")
  transactionId String?
  createdAt     DateTime @default(now())
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
}

model EngineerApplication {
  id         String    @id @default(cuid())
  token      String    @unique
  name       String
  email      String
  phone      String
  password   String
  status     String    @default("pending")
  adminId    String?
  adminNotes String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  reviewedAt DateTime?

  @@index([status])
  @@index([email])
  @@index([token])
  @@index([createdAt])
}

model HomepageContent {
  id        String   @id @default(cuid())
  content   String
  updatedAt DateTime @updatedAt
}

model FileExpiryTracker {
  id         String   @id @default(cuid())
  filePath   String
  expiryDate DateTime
  isDeleted  Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([expiryDate])
  @@index([isDeleted])
}
