# سيناريوهات التحقق من إصلاح صور المخططات

## المشاكل التي تم حلها

1. **400 Bad Request** من `/_next/image?url=...supabase.co/...`
2. **ملف مكسور / لا يظهر** في: تفاصيل الطلب، المحادثة، صفحة التعديل، لوحة المهندس
3. **تحميل الملف**: "لم يكن الموقع الإلكتروني متاحًا" عند الضغط على "تحميل المخطط"

---

## الحلول المطبقة

| الحل | الوصف |
|------|--------|
| **PlanImage** | مكوّن يعرض الروابط الخارجية (http/https أو //) بـ `<img>` مع **الرابط المباشر** لـ Supabase (لا يمر عبر _next/image) |
| **images.unoptimized** | في `next.config.js` لضمان عدم مرور أي صورة عبر `_next/image` |
| **تحميل المخطط** | مسار التحميل يجلب الملف من الرابط ثم عند الفشل يعيد التوجيه 302 لرابط الملف على Supabase |
| **/api/image-proxy** | (اختياري) مسار وكيل يجلب الصورة من Supabase ويعيدها للمتصفح؛ يمكن تفعيله من PlanImage عند الحاجة (CORS أو إخفاء الروابط) ويتطلب `NEXT_PUBLIC_SUPABASE_URL` |

---

## سيناريوهات التحقق (بعد النشر)

### سيناريو 1: لوحة تحكم العميل — تفاصيل الطلب
- الدخول إلى طلب فيه مخطط مرفوع (رابط Supabase).
- **المتوقع:** ظهور صورة المخطط في قسم "المخططات المرفوعة" بدون أيقونة مكسورة.
- **التحقق:** فتح Console (F12) — لا يظهر طلب لـ `_next/image` ولا خطأ 400.

### سيناريو 2: صفحة طلب تعديل المخطط (revision)
- الدخول إلى `/orders/[id]/revision` لطلب فيه مخطط.
- **المتوقع:** ظهور المخطط في منطقة الرسم مع إمكانية إضافة الدبابيس.
- **التحقق:** Console خالٍ من 400 لطلبات الصور.

### سيناريو 3: لوحة تحكم المهندس — المخططات المرفوعة
- الدخول كمهندس إلى تفاصيل طلب فيه مخططات.
- **المتوقع:** ظهور صور المخططات في البطاقات مع أزرار "تحميل" و "إرسال للعميل".
- **التحقق:** الصور تظهر ولا توجد طلبات فاشلة للصور.

### سيناريو 4: تحميل المخطط
- من تفاصيل الطلب أو المحادثة الضغط على "تحميل المخطط".
- **المتوقع:** يبدأ التحميل أو يفتح الملف في تاب جديد؛ لا تظهر رسالة "لم يكن الموقع الإلكتروني متاحًا".
- **ملاحظة:** إن فشل التحميل عبر الـ API يتم التوجيه تلقائياً لرابط Supabase.

### سيناريو 5: المحادثة — عرض مخطط التعديل
- فتح المحادثة واختيار تعديل مرتبط بمخطط.
- **المتوقع:** ظهور صورة المخطط مع الدبابيس إن وُجدت.
- **التحقق:** لا 400 في Console.

---

## متطلبات النشر

- العرض الحالي يعتمد على الرابط المباشر في `<img>` ولا يحتاج متغيرات إضافية لعرض الصور. مجلد المخططات في Supabase يجب أن يكون **public**.
- (اختياري) لاستخدام `/api/image-proxy` كبديل للعرض: تعيين **NEXT_PUBLIC_SUPABASE_URL** في Vercel.
- بعد دفع التعديلات، انتظار اكتمال البناء ثم إعادة تحميل الصفحة (أو Ctrl+F5) لتفادي الكاش القديم.
