# خطة فحص وإصلاح لوحة تحكم الإدارة

## نظرة عامة

هذا المستند يلخص فحص لوحة تحكم الإدارة (الأدمن)، المشاكل المكتشفة، وما تم إصلاحه أو ما يُنفَّذ لاحقاً.

---

## 1. هيكل لوحة الإدارة الحالي

| المسار | الوصف | API |
|--------|--------|-----|
| `/admin/dashboard` | لوحة التحكم الرئيسية — إحصائيات وروابط سريعة | `GET /api/admin/stats` |
| `/admin/orders` | قائمة جميع الطلبات مع فلتر وترتيب | `GET /api/admin/orders` |
| `/admin/packages` | إدارة الباقات (إضافة / تعديل / تعطيل) | `GET/POST /api/admin/packages`, `PUT/DELETE /api/admin/packages/[id]` |
| `/admin/engineers` | قائمة المهندسين وإحصائياتهم | `GET /api/admin/users?role=ENGINEER` |
| `/admin/engineers/applications` | طلبات انضمام المهندسين | `GET /api/admin/engineers/applications`, approve/reject |
| `/admin/settings/pin-pack` | سعر مجموعة الدبابيس والرسائل | `GET/PUT /api/admin/settings/pin-pack` |
| `/admin/settings/revisions-purchase` | سعر والحد الأقصى لشراء التعديلات | `GET/PUT /api/admin/settings/revisions-purchase` |
| `/admin/content/homepage` | محتوى الصفحة الرئيسية (هيرو، أسئلة شائعة، فوتر، سوشيال) | `GET/PUT /api/admin/content/homepage` |

---

## 2. المشاكل التي تم اكتشافها والحلول

### 2.1 إحصائيات المهندسين (تم إصلاحه)

- **المشكلة:** في `GET /api/admin/users?role=ENGINEER` كان `ordersCount` يُحسب من `clientOrders.length`، وهو دائماً 0 للمهندسين.
- **الحل:** تم تعديل الـ API بحيث:
  - للمهندس: `ordersCount` = عدد جميع الطلبات المعينة له، `completedOrdersCount` = الطلبات المكتملة فقط.
  - للعميل: `ordersCount` = عدد طلباته، `completedOrdersCount` = 0.
- **الملف:** `app/api/admin/users/route.ts`

### 2.2 صفحة الطلبات — عرض الباقة والسعر

- **الوضع:** الـ API يُرجع `package` و `packageForDisplay`. الواجهة تستخدم أحياناً `(order as any).packageForDisplay` كاحتياط.
- **التوصية:** توحيد الواجهة على استخدام `packageForDisplay` من الاستجابة وإضافتها إلى واجهة TypeScript `Order` لتفادي الـ cast وتحسين ظهور البيانات عند حذف باقة قديمة.

### 2.3 لوحة التحكم الرئيسية

- **زر العودة:** حالياً "العودة للصفحة الرئيسية" يوجّه إلى `/`. يمكن إبقاؤه أو إضافة رابط ثانوي "لوحة التحكم" يبقى في `/admin/dashboard` (الصفحة نفسها).
- **قسم الباقات:** الشبكة `md:grid-cols-2` تحتوي على بطاقة واحدة فقط (إجمالي الباقات). يمكن إما جعل القسم بطاقة واحدة بعرض كامل، أو إضافة بطاقة ثانية (مثلاً: الباقات غير النشطة أو عدد الباقات النشطة فقط) لملء الشبكة.

### 2.4 صفحة إدارة المهندسين

- **الألوان:** الصفحة تستخدم `gray-50` / `gray-900` بينما لوحة التحكم وباقي التطبيق يستخدمان `cream` / `charcoal`. يُفضّل توحيد الألوان مع دليل التصميم (DESIGN_SYSTEM) لتناسق المظهر.
- **حقل isActive:** الواجهة تعرض "نشط / غير نشط" لكن الـ API لا يُرجع حالياً حقل `isActive` للمستخدم. الكود يضع `isActive: true` افتراضياً (مع TODO). إذا وُجد حقل في قاعدة البيانات لاحقاً، ربطه بالـ API والواجهة.

---

## 3. التحقق من ظهور البيانات والتعديلات

### 3.1 الإحصائيات (Dashboard)

| البند | المصدر | الحالة |
|-------|--------|--------|
| إجمالي الطلبات + آخر 7 أيام | `stats.totalOrders`, `stats.recentOrders` | يعمل |
| إجمالي المستخدمين (عملاء / مهندسون) | `stats.totalUsers`, `totalClients`, `totalEngineers` | يعمل |
| إجمالي الإيرادات + آخر 30 يوم | `stats.totalRevenue`, `stats.recentRevenue` | يعمل |
| المهندسون النشطون | `stats.activeEngineers` (مهندس له طلب PENDING/IN_PROGRESS/REVIEW) | يعمل |
| الطلبات المعلقة / قيد التنفيذ / المكتملة | `pendingOrders`, `inProgressOrders`, `completedOrders` | يعمل |
| إجمالي الباقات والنشطة | `stats.totalPackages`, `stats.activePackages` | يعمل |

### 3.2 الطلبات (Orders)

| البند | الحالة |
|-------|--------|
| عرض رقم الطلب، الحالة، العميل، المهندس، الباقة، السعر، تاريخ الإنشاء، الموعد النهائي | يعمل |
| فلتر حسب الحالة (PENDING, IN_PROGRESS, …) | يعمل |
| ترتيب (الأحدث، الأقدم، حسب الموعد) | يعمل |
| pagination | يعمل |
| روابط "تفاصيل ورفع مخطط" و "عرض كعميل" | يعمل |
| دعم طلب بدون باقة (حذف الباقة لاحقاً) | يُعرض عبر `packageForDisplay` في API؛ توحيد الواجهة على ذلك موصى به |

### 3.3 الباقات (Packages)

| البند | الحالة |
|-------|--------|
| عرض القائمة، إضافة، تعديل، تعطيل/تفعيل | يعمل |
| حد 3 باقات ونظام المميزات (1/2/3 حسب ترتيب الإنشاء) | يعمل |
| التحقق من الحقول (Zod) في الـ API | يعمل |

### 3.4 المهندسون (Engineers)

| البند | الحالة |
|-------|--------|
| عرض الاسم، البريد، الجوال، تاريخ الانضمام | يعمل |
| إجمالي الطلبات والمكتملة | يعمل بعد إصلاح الـ API |
| زر "طلبات الانضمام" | يعمل |
| زر "إنشاء رابط دعوة" | معطّل (ميزة مستقبلية) |

### 3.5 الإعدادات والمحتوى

| الصفحة | العرض | التعديل |
|--------|--------|---------|
| سعر مجموعة الدبابيس | يعمل | يعمل (PUT) |
| سعر والحد الأقصى لشراء التعديلات | يعمل | يعمل (PUT) |
| محتوى الصفحة الرئيسية | يعمل | يعمل (PUT) |

---

## 4. خطة التنفيذ المقترحة (بالأولوية)

### مرحلة 1 — منفّذ

- [x] إصلاح عدّ طلبات المهندس في `GET /api/admin/users` (ordersCount و completedOrdersCount).

### مرحلة 2 — تنظيم البيانات والواجهة (مُنفَّذ)

- [x] **صفحة الطلبات:** إضافة `packageForDisplay` إلى واجهة `Order` واستخدامها في العرض مع عرض "—" و 0 عند عدم وجود باقة.
- [x] **لوحة التحكم:** تنظيم قسم الباقات — بطاقتان (إجمالي الباقات + الباقات النشطة) مع توضيح النشطة وغير النشطة.
- [x] **صفحة المهندسين:** توحيد الألوان مع باقي التطبيق (cream/charcoal و blue-gray/greige).

### مرحلة 3 — تحسينات اختيارية

- [ ] إضافة زر أو رابط "العودة للوحة التحكم" في الهيدر عند وجود المستخدم في مسارات `/admin/*` (إن لم يكن موجوداً في التصميم الحالي).
- [ ] دعم حقل `isActive` للمهندس في قاعدة البيانات والـ API إذا رُغب في تعطيل حساب مهندس دون حذفه.

---

## 5. المراجع

- المسارات المحمية للأدمن: [docs/AUTH.md](AUTH.md)
- تصميم الواجهة: [DESIGN_SYSTEM.md](../DESIGN_SYSTEM.md)
- API الطلبات والإحصائيات: [API.md](../API.md) (إن وُجد)

**آخر تحديث:** 4 فبراير 2026
