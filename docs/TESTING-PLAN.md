# خطة الفحص والتأكد — منصة فكرة

دليل منهجي للتحقق من أن المشروع يعمل بشكل صحيح وخالٍ من الأخطاء (محلياً وعلى Vercel + Supabase).

---

## نظرة عامة

| المرحلة | الهدف |
|--------|--------|
| 1. بيئة محلية | التأكد من البناء والتشغيل والاتصال بقاعدة البيانات |
| 2. واجهات API الأساسية | التحقق من المسارات التي تعتمد عليها الواجهة |
| 3. المصادقة | التسجيل، تسجيل الدخول، نسيت كلمة المرور |
| 4. سيناريوهات أخطاء | التأكد من عدم ظهور 500 غير متوقعة ووضوح الرسائل |
| 5. النشر (Vercel) | التحقق بعد النشر وفحص الصحة |

---

## 1. البيئة المحلية

### 1.1 المتطلبات

- [ ] Node.js (الإصدار المدعوم في `package.json` / `.nvmrc` إن وُجد).
- [ ] ملف `.env` موجود ويحتوي على:
  - `DATABASE_URL` (رابط PostgreSQL، مع `?pgbouncer=true` إن استخدمت Pooler).
  - `NEXTAUTH_SECRET`, `NEXTAUTH_URL` (مثلاً `http://localhost:3000`).
  - إن استخدمت Supabase: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, واختياري `SUPABASE_SERVICE_ROLE_KEY`, `USE_SUPABASE_AUTH`, `NEXT_PUBLIC_USE_SUPABASE_AUTH`.

### 1.2 تثبيت وبناء

```bash
npm ci
npx prisma generate
npm run build
```

- [ ] لا توجد أخطاء في `npm run build`.
- [ ] لا أخطاء من `npm run lint` (إن كان مفعّلاً).

### 1.3 قاعدة البيانات

```bash
npx prisma db push
```

- [ ] الأمر ينفذ بنجاح (لا P1000، لا P4002).
- إن ظهر P4002 (قيد مع `auth.users`) راجع **docs/supabase-fix-fk-for-prisma.sql** ونفّذ الإصلاح من Supabase SQL Editor ثم أعد `db push`.

### 1.4 تشغيل التطبيق

```bash
npm run dev
```

- [ ] التطبيق يعمل على `http://localhost:3000`.
- [ ] الصفحة الرئيسية تُحمّل بدون خطأ في المتصفح.

---

## 2. فحص واجهات API الأساسية

يُفضّل استخدام المتصفح أو أداة مثل **curl** أو **Postman**. يمكن أيضاً الاعتماد على واجهة التطبيق عند تنفيذ الخطوات في القسم 3.

### 2.1 صحة النظام (Health) — محلي

- **الطلب:** `GET http://localhost:3000/api/system/health`
- **التحقق:**  
  - إن وُجد `HEALTH_CHECK_SECRET`: أضف الهيدر `x-health-secret: <قيمة المتغير>` أو استخدم `?secret=<قيمة المتغير>`.  
  - أو سجّل دخول كـ Admin وافتح الرابط من المتصفح.
- **المتوقع:**
  - [ ] الاستجابة **200** مع `"success": true`.
  - [ ] `database.ok === true`.
  - [ ] إن Supabase مفعّل: `auth.ok === true` و `storage.ok === true` (أو رسالة واضحة إن تم تخطي الفحص).

### 2.2 باقات الخدمات

- **الطلب:** `GET http://localhost:3000/api/packages`
- **المتوقع:**
  - [ ] الاستجابة **200** و body يحتوي على مصفوفة (قد تكون فارغة).

### 2.3 محتوى الصفحة الرئيسية

- **الطلب:** `GET http://localhost:3000/api/content/homepage`
- **المتوقع:**
  - [ ] الاستجابة **200** (أو 404 إن لم يُضف محتوى بعد؛ لا 500).

### 2.4 التسجيل (API فقط — اختبار سريع)

- **الطلب:** `POST http://localhost:3000/api/auth/register`  
  **Body (JSON):**  
  `{ "name": "اختبار", "email": "test-check@example.com", "phone": "0599999999", "password": "TestPass123!", "confirmPassword": "TestPass123!" }`
- **المتوقع:**
  - [ ] إما **200** مع `"success": true`، أو **400** (مثلاً بريد/جوال مستخدم)، أو **503** مع رسالة واضحة (مثل إعداد Supabase غير مكتمل).
  - [ ] لا **500** مع رسالة عامة "حدث خطأ ما" فقط (إن استمر 500 راجع Vercel Function Logs أو سجلات الخادم لمعرفة السبب).

---

## 3. المصادقة من الواجهة

### 3.1 التسجيل

- [ ] فتح `/register`.
- [ ] تعبئة الحقول بشكل صحيح (اسم، بريد، جوال، كلمة مرور، تأكيد كلمة المرور).
- [ ] الضغط على "إنشاء حساب".
- **المتوقع:**
  - [ ] إما نجاح وتوجيه لتسجيل الدخول أو للوحة التحكم.
  - [ ] أو رسالة خطأ واضحة (مثل: بريد/جوال مستخدم، أو إعداد المصادقة غير مكتمل) وليس 500 فقط.

### 3.2 تسجيل الدخول

- [ ] فتح `/login`.
- [ ] إدخال بريد وكلمة مرور صحيحين.
- **المتوقع:**
  - [ ] نجاح الدخول والتوجيه حسب الدور (عميل / مهندس / أدمن).

### 3.3 نسيت كلمة المرور (إن كان مفعّلاً)

- [ ] من صفحة تسجيل الدخول استخدام "نسيت كلمة المرور" إن وُجد.
- **المتوقع:**
  - [ ] لا 500؛ إما نجاح إرسال الرابط أو رسالة خطأ مفهومة.

---

## 4. سيناريوهات أخطاء متوقعة

الهدف: التأكد من أن الأخطاء **لا تظهر كـ 500 عامة** وأن الرسائل واضحة حيث أمكن.

| السيناريو | الإجراء | المتوقع |
|-----------|---------|---------|
| تسجيل ببريد/جوال مستخدم مسبقاً | إنشاء حساب ثم محاولة التسجيل بنفس البريد أو الجوال مرة أخرى | **400** مع رسالة مثل "البريد الإلكتروني أو رقم الجوال مستخدم بالفعل". |
| Supabase مفعّل ومتغيراته ناقصة (مثلاً على Vercel) | تفعيل `USE_SUPABASE_AUTH` بدون `NEXT_PUBLIC_SUPABASE_URL` أو `NEXT_PUBLIC_SUPABASE_ANON_KEY` | **503** ورسالة توجيهية (إعداد المصادقة غير مكتمل أو تحقق من متغيرات Supabase). |
| قاعدة البيانات غير متاحة أو `DATABASE_URL` خاطئ | إيقاف قاعدة البيانات أو استخدام رابط خاطئ | **503** ورسالة مثل "تعذر الاتصال بقاعدة البيانات" (أو ما يُرجعه `handleApiError` لأخطاء الاتصال). |
| طلب Health بدون صلاحية | `GET /api/system/health` بدون سكرت ولا جلسة أدمن | **401** مع تلميح (استخدام السكرت أو الدخول كأدمن). |

---

## 5. النشر على Vercel والتحقق

### 5.1 قبل النشر

- [ ] مراجعة **docs/VERCEL-SUPABASE-CHECKLIST.md** (متطلبات، قاعدة البيانات، متغيرات البيئة، Supabase Auth و Storage).
- [ ] `DATABASE_URL` على Vercel = رابط **Transaction (منفذ 6543)** مع **`?pgbouncer=true`** في النهاية.
- [ ] جميع المتغيرات المطلوبة مضبوطة (Production/Preview حسب الحاجة) ثم **Redeploy** بعد أي تعديل على المتغيرات.

### 5.2 بعد النشر

- [ ] الصفحة الرئيسية تُحمّل: `https://<المشروع>.vercel.app`.
- [ ] **التسجيل:** إنشاء حساب جديد من `/register` — لا 500؛ إما نجاح أو رسالة خطأ واضحة.
- [ ] **تسجيل الدخول:** الدخول بحساب موجود والتأكد من التوجيه للوحة التحكم.
- [ ] **صحة النظام (على Vercel):**  
  `GET https://<المشروع>.vercel.app/api/system/health` مع `x-health-secret` أو `?secret=` يساوي `HEALTH_CHECK_SECRET`.  
  - [ ] الاستجابة **200** و `success: true`.
  - [ ] التحقق من أن `database.ok` و `auth.ok` و `storage.ok` (حسب الإعداد) كلها `true`. إن كان أي منها `false` راجع حقل `summary` في الاستجابة وربط النتيجة بجدول "أخطاء شائعة وحلولها" في **docs/VERCEL-SUPABASE-CHECKLIST.md**.

### 5.3 إن استمر خطأ 500 على التسجيل

1. من **Vercel → المشروع → Deployments → آخر نشر → Logs** (أو **Functions → الدالة المناسبة → Logs**) ابحث عن سطر **"Register failed"** واطلع على `message` و `code`.
2. راجع **docs/VERCEL-SUPABASE-CHECKLIST.md** قسم "إذا ظهر 500 على التسجيل أو الباقات أو المحتوى" وجدول "أخطاء شائعة".
3. تأكد من أن **Redeploy** تم بعد ضبط `DATABASE_URL` والمتغيرات.

---

## 6. قائمة تحقق سريعة (بدون أخطاء)

- [ ] `npm run build` ناجح محلياً.
- [ ] `npx prisma db push` ناجح.
- [ ] `GET /api/system/health` (مع صلاحية) يُرجع 200 و `success: true`.
- [ ] `GET /api/packages` و `GET /api/content/homepage` لا يُرجعان 500.
- [ ] التسجيل من الواجهة لا يُرجع 500 غير متوقعة؛ إما نجاح أو 400/503 مع رسالة واضحة.
- [ ] تسجيل الدخول يعمل ويوجّه حسب الدور.
- [ ] على Vercel: نفس النقاط بعد النشر، مع التأكد من `DATABASE_URL` (Transaction + `?pgbouncer=true`) وRedeploy بعد تعديل المتغيرات.

---

للتفاصيل التقنية (إعداد Supabase، قاعدة البيانات، المتغيرات) راجع:

- **docs/VERCEL-SUPABASE-CHECKLIST.md**
- **docs/SUPABASE-DATABASE.md**
- **docs/SUPABASE-SETUP.md**
