# قائمة التحقق من الفحص والنشر وسير العمل

هذا المستند يلخص ما تم التحقق منه آلياً وما يجب التحقق منه يدوياً (GitHub، Supabase، Vercel، واختبارات E2E).

---

## المرحلة 1: فحص المشروع (تم التحقق منه)

- [x] **البنية:** `npm run build` و `npm run lint` ناجحان؛ لا أخطاء TypeScript/ESLint.
- [x] **Prisma:** `provider = "postgresql"`؛ وجود النماذج: User, Order, Plan, Message, RevisionRequest, Package, Notification, Payment, PinPackConfig, RevisionsPurchaseConfig, EngineerApplication, HomepageContent.
- [x] **المصادقة:** مسارات `/api/admin/*` تستخدم `requireAdmin`؛ `/api/engineer/*` وخطط الرفع/الإرسال تستخدم `requireEngineerOrAdmin`؛ إنشاء الطلب والإنهاء وشراء التعديلات وطلب التعديل تستخدم `requireClient`؛ الباقي `requireAuth`.
- [x] **الـ Middleware:** توجيه حسب الدور (عميل/مهندس/أدمن)؛ صفحة لوحة العميل تعيد توجيه المهندس والأدمن إلى لوحتهم.
- [x] **المسارات العامة:** مطابقة [lib/routes.ts](lib/routes.ts) للصفحات والـ API العامة.
- [x] **سير الطلب:** إنشاء طلب، بدء العمل، رفع/إرسال مخطط، طلب تعديل، إنهاء الطلب؛ تحديث الحالة التلقائي عند انتهاء الموعد في [app/api/orders/[id]/route.ts](app/api/orders/[id]/route.ts).

---

## المرحلة 2: التحقق من الرفع والنشر

### GitHub (تم التحقق منه)

- [x] الفرع المحلي متزامن مع `origin/main`.
- [x] `.env` و `.env*.local` في [.gitignore](.gitignore).

### Supabase (تحقق يدوي)

- [ ] **قاعدة البيانات:** من Supabase Dashboard → Project Settings → Database، التأكد من استخدام **Connection string → Transaction** (منفذ 6543) مع إضافة `?pgbouncer=true` في نهاية الرابط.
- [ ] **المصادقة:** إن كان المشروع يستخدم Supabase Auth، من Authentication → URL Configuration: **Site URL** و **Redirect URLs** (بما فيها `/reset-password`) مطابقة لرابط الموقع المنشور.
- [ ] **الهجرات:** تشغيل `npx prisma migrate deploy` أو `npx prisma db push` مرة واحدة من جهازك مع `.env` يشير إلى نفس مشروع Supabase.

### Vercel (تحقق يدوي)

- [ ] **Git:** من Vercel → Project → Settings → Git، التأكد من أن Production Branch = `main`.
- [ ] **متغيرات البيئة:** مراجعة [docs/DEPLOYMENT.md](docs/DEPLOYMENT.md) والتأكد من تعبئة: `DATABASE_URL` (pooler + `?pgbouncer=true`)، `NEXTAUTH_SECRET`، `NEXTAUTH_URL`، وإذا Supabase: `USE_SUPABASE_AUTH`، `NEXT_PUBLIC_USE_SUPABASE_AUTH`، `NEXT_PUBLIC_SUPABASE_URL`، `NEXT_PUBLIC_SUPABASE_ANON_KEY`.
- [ ] **بعد النشر:** فتح رابط الموقع، الصفحة الرئيسية، تسجيل الدخول، ومسار يستخدم DB (مثل `/api/packages` أو `/api/orders/my-orders`) للتأكد من عدم 503.

---

## المرحلة 3: فحص سير العمل (E2E — تحقق يدوي)

### 3.1 التسجيل والدخول والصلاحيات

| الخطوة | تحقق |
|--------|------|
| قبل التسجيل | [ ] الصفحات العامة (الرئيسية، تسجيل، دخول، نسيت كلمة المرور) تفتح بدون إعادة توجيه للدخول. |
| أثناء التسجيل | [ ] التحقق من البريد والجوال (تفرد)؛ رسالة خطأ واضحة عند تكرار البريد/الجوال. |
| بعد التسجيل | [ ] عند النجاح: توجيه حسب الدور أو إلى تسجيل الدخول. |
| تسجيل الدخول | [ ] عميل → `/dashboard`؛ مهندس → `/engineer/dashboard`؛ أدمن → `/admin/dashboard`. |
| الصلاحيات | [ ] عميل يفتح `/admin/dashboard` يُعاد توجيهه أو 403. |

### 3.2 إنشاء الطلب

| الخطوة | تحقق |
|--------|------|
| إنشاء طلب | [ ] العميل يختار باقة، يملأ النموذج (الخطوات الخمس)، يُرسل. |
| الظهور | [ ] الطلب يظهر في لوحة العميل "في الانتظار"؛ في لوحة المهندس ضمن الطلبات غير المعيّنة؛ في لوحة الأدمن. |

### 3.3 المحادثة

| الخطوة | تحقق |
|--------|------|
| محادثة عميل–مهندس | [ ] إرسال رسالة من العميل تظهر للمهندس؛ والعكس. |
| الأدمن | [ ] إن فتح الأدمن المحادثة، الرسائل تظهر والإرسال يعمل حسب الصلاحيات. |

### 3.4 المهندس: رفع وإرسال مخطط وتحميل

| الخطوة | تحقق |
|--------|------|
| بدء العمل | [ ] المهندس يضغط "بدء العمل"؛ الطلب يتحول إلى "قيد التنفيذ". |
| رفع مخطط | [ ] رفع ملف/صورة عبر "رفع مخطط" ينجح (أو 503 مع رسالة واضحة إن لم يُضبط التخزين). |
| إرسال للعميل | [ ] المهندس يختار المخططات ويضغط "إرسال المخطط"؛ الحالة "مكتمل". |
| تحميل | [ ] العميل يرى المخططات النشطة ويستطيع تحميل الملف/الصورة. |

### 3.5 العميل: تعديل ودبابيس وإرسال للمهندس

| الخطوة | تحقق |
|--------|------|
| طلب تعديل | [ ] العميل يفتح صفحة التعديلات، يضع دبابيس مع ملاحظات، يرسل؛ يُخصم من التعديلات المتبقية؛ الحالة "قيد التنفيذ". |
| المهندس | [ ] المهندس يرى طلب التعديل؛ ينفّذ ويرفع مخططاً جديداً ويرسله؛ العميل يرى المخطط الجديد ويحمّله. |

### 3.6 حالة الطلب

| الخطوة | تحقق |
|--------|------|
| تغيير الحالة | [ ] تغيير الحالة من لوحة المهندس/الأدمن يعمل؛ الإشعارات تصل للعميل عند الحالات المحددة. |
| إنهاء الطلب | [ ] العميل لا يستطيع تأكيد إنهاء الطلب إلا عندما الحالة "مكتمل"؛ بعد التأكيد الحالة "منتهي" ولا يمكن طلب تعديلات. |

### 3.7 الأدمن

| الخطوة | تحقق |
|--------|------|
| الطلبات | [ ] عرض كل الطلبات، فلترة، تغيير الحالة. |
| المهندسون | [ ] طلبات الانضمام، قبول/رفض، قائمة المهندسين. |
| الباقات والإعدادات | [ ] إضافة/تعديل/حذف باقات؛ إعدادات مجموعة الدبابيس وسعر التعديل الإضافي. |
| محتوى الصفحة الرئيسية | [ ] تحرير المحتوى يظهر على الصفحة الرئيسية للموقع. |

### 3.8 تأثير التغييرات (طلبات جديدة فقط حيث يجب)

| نوع التغيير | تحقق |
|-------------|------|
| تعديل الباقات | [ ] طلب جديد بعد التعديل يحمل قيم الباقة المحدثة؛ الطلبات القديمة لا تتغير. |
| إعدادات الأسعار (دبابيس، تعديل إضافي) | [ ] عند شراء إضافات يُحمّل السعر من الإعدادات الحالية. |
| محتوى الصفحة الرئيسية | [ ] التعديل يظهر على الصفحة الرئيسية (عرض فقط). |

---

مرجع سير الطلب الكامل: [docs/ORDER-WORKFLOW.md](docs/ORDER-WORKFLOW.md).  
مرجع النشر: [docs/DEPLOYMENT.md](docs/DEPLOYMENT.md).
