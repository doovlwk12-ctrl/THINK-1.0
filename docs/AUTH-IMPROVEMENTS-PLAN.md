# خطة إصلاح وتحسين سير عمل المصادقة

هذا الملف يلخّص خطة التحسين المعتمدة على [AUTH-WORKFLOW.md](AUTH-WORKFLOW.md) وحالة تنفيذها.

---

## 1. توحيد سلوك ما بعد التسجيل (مُنفَّذ)

**الهدف:** عندما ينشئ عميل حساباً من المنصة يُسجّل في المنصة ويسجّل الدخول بدون مشاكل.

**ما تم تنفيذه:**
- في [app/(auth)/register/page.tsx](../app/(auth)/register/page.tsx): بعد نجاح `POST /api/auth/register` يتم استدعاء `signIn(email, password)` في **كلا النظامين** (Supabase و NextAuth).
- إن نجح تسجيل الدخول: التوجيه فوراً إلى اللوحة حسب الدور (عميل/مهندس/أدمن) باستخدام `getDashboardPathByRole`؛ مع NextAuth يُستدعى `getSession()` عند عدم وجود `result.user`.
- إن فشل: عرض رسالة الخطأ والتوجيه إلى `/login`.

**النتيجة:** تجربة موحّدة بعد إنشاء الحساب؛ المستخدم يصل إلى لوحة التحكم مباشرة دون الحاجة لتسجيل دخول يدوي.

---

## 2. تحسين توجيه تسجيل الدخول (مُنفَّذ)

**ما تم تنفيذه سابقاً:**
- في [app/(auth)/login/page.tsx](../app/(auth)/login/page.tsx): بعد نجاح `signIn` مع NextAuth، عند عدم وجود `result.user` يتم استدعاء `getSession()` للحصول على الدور ثم التوجيه إلى اللوحة الصحيحة.

---

## 3. توثيق سير العمل والتحسينات (مُنفَّذ)

**ما تم تنفيذه:**
- تحديث [AUTH-WORKFLOW.md](AUTH-WORKFLOW.md):
  - توضيح السلوك الموحّد بعد التسجيل (قسم 2).
  - إضافة قسم "استجابة الأخطاء في الـ API" (401/403).
  - تحديث قائمة التحقق لتعكس التوجيه التلقائي بعد التسجيل.
  - إضافة قسم "تحسينات مطبّقة وسجل التغييرات".

---

## 4. مراجعة استجابات الأخطاء في الـ API (مُنفَّذ)

- تمت مراجعة مسارات الـ API: معظمها يعيد إما استجابة دوال [lib/requireAuth.ts](../lib/requireAuth.ts) أو `{ error: string }` بالعربية.
- تم توحيد المسار الوحيد الذي كان يُرجع 403 بدون جسم: [app/api/orders/[id]/plans/[planId]/download/route.ts](../app/api/orders/[id]/plans/[planId]/download/route.ts) يعيد الآن `{ error: 'غير مصرح - لا توجد صلاحية كافية' }`.

---

## 5. دليل اختبار يدوي للمصادقة (مُنفَّذ)

- تم إنشاء [MANUAL-AUTH-TESTING.md](MANUAL-AUTH-TESTING.md) بخطوات تنفيذية (الخطوة، الرابط، المتوقّع، حالة التنفيذ) مطابقة لقائمة التحقق في AUTH-WORKFLOW (القسم 8).
- في [AUTH-WORKFLOW.md](AUTH-WORKFLOW.md) تمت الإشارة صراحة إلى الدليل لتنفيذ قائمة التحقق.

---

## 6. توجيه Supabase حسب الدور من /login و /register (اختياري)

- **الوضع الحالي:** مستخدم مسجل (Supabase) يفتح `/login` أو `/register` يُوجّه إلى `/dashboard`؛ إن كان مهندساً/أدمن تُصحح لوحة العميل المسار.
- **التحسين المقترح:** تخزين الدور في كوكي قصير العمر عند تسجيل الدخول أو عند استدعاء `/api/auth/me`، وقراءته في الـ middleware لتوجيه مباشر إلى `/admin/dashboard` أو `/engineer/dashboard` دون توجيه مزدوج.
- تعقيد متوسط؛ يمكن تأجيله.

---

## المراجع

- سير العمل الكامل: [AUTH-WORKFLOW.md](AUTH-WORKFLOW.md)
- المصادقة والصلاحيات: [AUTH.md](AUTH.md)
- المسارات العامة: [lib/routes.ts](../lib/routes.ts)

**آخر تحديث:** 4 فبراير 2026
