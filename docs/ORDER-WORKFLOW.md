# سير عمل الطلب — من العميل إلى المهندس حتى الإغلاق

توثيق كامل لرحلة الطلب في منصة فكرة: من إنشاء العميل للطلب، مروراً بالمهندس والتعديلات، حتى إنهاء الطلب وإغلاقه، مع أدوار الأدمن وشروط الظهور.

---

## 1. حالات الطلب (Order Status)

| الحالة | الاسم بالعربية | المعنى |
|--------|----------------|--------|
| `PENDING` | في الانتظار | الطلب جديد ولم يبدأ به مهندس بعد |
| `IN_PROGRESS` | قيد التنفيذ | المهندس يعمل على الطلب (بدأ العمل أو يعيد العمل بعد تعديل) |
| `REVIEW` | قيد المراجعة | المهندس أرسل مخططاً والعميل يراجعه (لم يُحدّد مكتمل بعد) |
| `COMPLETED` | مكتمل | المهندس أنهى العمل ووضع الطلب "مكتمل" — بانتظار تأكيد إنهاء من العميل |
| `CLOSED` | منتهي | العميل أكد إنهاء الطلب — لا مزيد من تعديلات أو إجراءات |
| `ARCHIVED` | مؤرشف | انتهى الموعد النهائي دون أن يكون الطلب "مكتمل" ثم "منتهي" — أو تحوّل تلقائي عند انتهاء المدة |

**قاعدة تلقائية:** عند انتهاء `deadline` (الموعد النهائي):
- إذا كانت الحالة `COMPLETED` → تُحدَّث إلى `CLOSED`.
- إذا كانت أي حالة أخرى (ما عدا CLOSED و ARCHIVED) → تُحدَّث إلى `ARCHIVED`.

---

## 2. رحلة الطلب خطوة بخطوة

### المرحلة 1: العميل ينشئ الطلب

1. **العميل:** يختار باقة من الصفحة الرئيسية أو من لوحة التحكم، ثم يملأ نموذج إنشاء الطلب (الخطوات الخمس).
2. **النظام:** ينشئ الطلب بحالة `PENDING`، ويربطه بالعميل والباقة، ويحدد `deadline` وعدد التعديلات المتبقية حسب الباقة.
3. **الظهور:**
   - يظهر الطلب في **لوحة تحكم العميل** (`/dashboard`) وفي **طلباتي**.
   - يظهر في **لوحة تحكم المهندس** ضمن الطلبات "في الانتظار" (بدون مهندس معيّن).
   - يظهر في **لوحة الأدمن** (`/admin/orders`) ضمن كل الطلبات.

---

### المرحلة 2: المهندس يبدأ العمل

1. **المهندس:** يدخل إلى الطلب من لوحة المهندس (`/engineer/orders/[id]`) ويضغط "بدء العمل" (استدعاء `POST /api/engineer/orders/[id]/start`).
2. **النظام:** يحدّث الطلب إلى `IN_PROGRESS` ويعيّن `engineerId` للمهندس الحالي.
3. **الظهور:**
   - الطلب يظهر للمهندس تحت "قيد التنفيذ".
   - العميل يرى الحالة "قيد التنفيذ" وقد يصله إشعار "تم بدء العمل على طلبك".

**ملاحظة:** إذا غيّر المهندس الحالة يدوياً إلى "قيد التنفيذ" (من قائمة الحالات) دون الضغط على "بدء العمل"، يُعيّن هو أيضاً كالمهندس المسؤول إن لم يكن معيّناً.

---

### المرحلة 3: المهندس يرفع المخططات ويرسلها للعميل

1. **المهندس:** يرفع ملفات المخططات (صور/PDF) عبر "رفع مخطط" (`/api/plans/upload`)، ثم يختار المخططات ويرسلها للعميل عبر "إرسال المخطط" (استدعاء `POST /api/plans/send` مع `orderId` و `planIds`).
2. **النظام:**
   - يفعّل المخططات المختارة ويوقف الباقي.
   - يحدّث حالة الطلب إلى `COMPLETED` ويسجّل `completedAt`.
   - يرسل إشعاراً للعميل ورابط واتساب (إن وُجد).
3. **الظهور:**
   - العميل يرى الطلب "مكتمل" ويرى المخططات النشطة ويمكنه تحميلها.
   - يظهر للعميل خيار "طلب تعديل" (إن وُجدت تعديلات متبقية) أو "تأكيد إنهاء الطلب" (إن لم تبقَ تعديلات).

---

### المرحلة 4: العميل يطلب تعديلاً (اختياري — قد تتكرر)

1. **العميل:** يدخل إلى صفحة التعديلات للطلب (`/orders/[id]/revision`) ويضع دبابيس على المخطط مع ملاحظات، ثم يرسل طلب التعديل (`POST /api/revisions/create`).
2. **الشروط:** الطلب ليس `CLOSED`، ولم ينتهِ الموعد مع حالة `ARCHIVED`، ويوجد `remainingRevisions > 0` ويوجد مخطط نشط.
3. **النظام:** ينشئ طلب تعديل (RevisionRequest)، يخصم واحدة من `remainingRevisions` ويحدّث حالة الطلب إلى `IN_PROGRESS` حتى يعمل المهندس على التعديل.
4. **الظهور:**
   - المهندس يرى طلب التعديل في الطلب وصفحة التعديل (`/engineer/orders/[id]/revision/[revisionId]`).
   - يعمل على التعديل ثم يرفع مخططاً جديداً ويُرسله للعميل (العودة إلى المرحلة 3).

هذه الدورة (مهندس يرسل → عميل يراجع ويطلب تعديل → مهندس يعمل ويرسل) يمكن أن تتكرر حتى تنتهي التعديلات المتبقية أو يقرر العميل إنهاء الطلب.

---

### المرحلة 5: العميل يؤكد إنهاء الطلب (إغلاق)

1. **العميل:** عندما تكون الحالة `COMPLETED` ولا يريد مزيداً من تعديلات، يضغط "تأكيد إنهاء الطلب" (استدعاء `POST /api/orders/[id]/complete`).
2. **الشروط:** الطلب يجب أن يكون بحالة `COMPLETED` (أي أن المهندس قد وضع الطلب "مكتمل").
3. **النظام:** يحدّث الحالة إلى `CLOSED`، ويرسل إشعاراً للمهندس وإشعاراً للعميل بضرورة الاحتفاظ بنسخة من المخططات (لأن الملفات تُحذف من المنصة بعد 45 يوماً من الموعد النهائي).
4. **بعد الإغلاق:**
   - لا يمكن طلب تعديلات جديدة.
   - الطلب يظهر "منتهي" للجميع.

---

### المرحلة 6: انتهاء الموعد والأرشفة

- عند انتهاء `deadline`:
  - إذا الطلب `COMPLETED` → يصبح `CLOSED` تلقائياً.
  - إذا الطلب غير منتهٍ → يصبح `ARCHIVED`.
- الطلبات `CLOSED` أو `ARCHIVED`: بعد **45 يوماً من الموعد النهائي** يُحذف ملف المخططات من المنصة (Cron: `/api/cron/purge-archived-plans`)، ويبقى الطلب كسجل بدون تحميل.
- **الظهور:** الطلبات المؤرشفة تظهر في لوحة العميل والمهندس والأدمن مع تنبيه أن الملفات محذوفة أو أن الطلب منتهٍ.

---

## 3. إجراءات إضافية للعميل

| الإجراء | الشرط | الوصف |
|---------|--------|--------|
| شراء تعديلات إضافية | الطلب IN_PROGRESS أو REVIEW أو COMPLETED و remainingRevisions = 0 | شراء حزمة تعديلات (حسب إعدادات المنصة) |
| شراء تمديد | الطلب منتهي الموعد وحالته ARCHIVED | تمديد الموعد النهائي وإعادة الحالة إلى قيد التنفيذ |
| شراء مجموعة دبابيس | حسب إعدادات الباقة/المنصة | لاستخدام دبابيس إضافية في التعديلات |

---

## 4. إجراءات المهندس

| الإجراء | الشرط | الوصف |
|---------|--------|--------|
| بدء العمل | الطلب PENDING (أو غير معيّن له مهندس) | تعيين المهندس وتحويل الحالة إلى IN_PROGRESS |
| رفع مخطط | الطلب معيّن للمهندس | رفع ملفات (صور/PDF) للمخطط |
| إرسال المخطط للعميل | وجود مخططات مرفوعة | تفعيل المخططات المختارة وتحديث الطلب إلى COMPLETED وإشعار العميل |
| تغيير حالة الطلب | الطلب معيّن للمهندس (أو أدمن) | تغيير يدوي بين PENDING, IN_PROGRESS, REVIEW, COMPLETED, CLOSED, ARCHIVED (حسب الصلاحيات) |
| تنفيذ طلب التعديل | وجود RevisionRequest للطلب | فتح صفحة التعديل، تنفيذ التعديلات، رفع مخطط جديد وإرساله |

---

## 5. دور الأدمن وإجراءاته

| الصلاحية / الإجراء | الوصف |
|---------------------|--------|
| عرض كل الطلبات | `/admin/orders` — قائمة بكل الطلبات مع فلترة حسب الحالة والترتيب |
| تغيير حالة الطلب | الأدمن يمكنه استخدام نفس واجهة تغيير الحالة (مثل المهندس) عبر `PUT /api/engineer/orders/[id]/status` لأنه مُصرّح بـ requireEngineerOrAdmin |
| إدارة المهندسين | قبول/رفض طلبات الانضمام (`/admin/engineers/applications`) وقائمة المهندسين |
| إدارة الباقات | إضافة/تعديل الباقات والأسعار |
| إعدادات المنصة | إعدادات مجموعة الدبابيس، سعر التعديل الإضافي، إلخ |
| المحتوى | تحرير محتوى الصفحة الرئيسية (هيرو، أسئلة شائعة، روابط، إلخ) |

**ظهور الطلبات للأدمن:** يرى كل الطلبات بجميع الحالات؛ لا يوجد طلب مخفي عن الأدمن.

---

## 6. شروط ظهور الطلب والمحتوى

| الجهة | ما يظهر |
|-------|---------|
| **العميل** | كل الطلبات التي `clientId` يساوي حسابه؛ مع تفاصيل الحالة، المخططات النشطة، المحادثة، طلبات التعديل، وأزرار الشراء/التمديد/التأكيد حسب الحالة |
| **المهندس** | الطلبات التي `engineerId` يساوي حسابه، أو الطلبات `PENDING` (بدون مهندس) ليقبلها؛ لا يرى طلبات عملاء آخرين المعيّنة لمهندس آخر |
| **الأدمن** | كل الطلبات مع إمكانية فلترة وتغيير الحالة؛ كل إعدادات المنصة والمهندسين والمحتوى |

**الملفات (المخططات):** تُخفى عن الواجهة إذا كان الطلب قد مرّ عليه 45 يوماً من الموعد النهائي وتم تنفيذ مهمة الحذف (`plansPurgedAt`)، أو إذا المخطط مُحذوف (حقل `purgedAt` أو `fileUrl` فارغ).

---

## 7. ملخص تدفق الحالات

```
عميل ينشئ الطلب
       ↓
   PENDING
       ↓
مهندس يبدأ العمل (أو يُعيّن من أدمن/واجهة الحالة)
       ↓
  IN_PROGRESS  ←──┐
       ↓          │ عميل يطلب تعديل (remainingRevisions)
مهندس يرفع ويُرسل المخطط
       ↓          │
  COMPLETED ─────┘
       ↓
عميل يؤكد إنهاء الطلب
       ↓
   CLOSED (منتهي — لا مزيد من إجراءات)

(انتهاء الموعد دون إغلاق → ARCHIVED؛ انتهاء الموعد والطلب COMPLETED → CLOSED تلقائياً)
```

بعد تطبيق هذا السير تكون كل إجراءات العميل والمهندس والأدمن، وظهور الطلبات وشروط الظهور، موثّقة ومتسقة مع سلوك المنصة.
