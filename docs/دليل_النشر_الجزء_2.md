# Part 2: التحقق بعد النشر، النطاق المخصص، والمراقبة

دليل النشر — الجزء الثاني: التحقق بعد النشر، إعداد النطاق المخصص على Vercel، والمراقبة باستخدام Health Check و Speed Insights.

---

## الوضع الحالي

- **Part 1** مضبوط في رفع_على_المنصات.md: رفع على GitHub، النشر على Vercel/Render، متغيرات البيئة.
- المشروع يحتوي على:
  - app/api/system/health/route.ts: واجهة تشخيص (قاعدة البيانات، Auth، Storage) محمية بـ HEALTH_CHECK_SECRET أو جلسة Admin.
  - docs/HEALTH-CHECK.md: توثيق استدعاء الـ health مع السري والاستجابة.
  - app/layout.tsx: مكوّن SpeedInsights من Vercel مفعّل (يظهر في Vercel Dashboard بعد النشر).

## الهدف

توسيع التوثيق بجزء ثانٍ يغطي: **التحقق بعد النشر**، **النطاق المخصص**، و**المراقبة**، دون تغيير سلوك التطبيق.

---

## 1. التحقق بعد النشر (Verification Checklist)

- **قائمة تحقق:**
  - فتح الرابط المنشور والتأكد من تحميل الصفحة الرئيسية.
  - تجربة **إنشاء حساب** ثم **تسجيل الدخول**.
  - التأكد من وصول لوحة التحكم (عميل/مهندس/أدمن حسب الدور).
  - (اختياري) إنشاء طلب تجريبي للتأكد من تدفق الطلبات والـ API.
- **Supabase:**
  - **Authentication → URL Configuration**: **Site URL** = رابط الموقع المنشور (بدون `/` في النهاية).
  - **Redirect URLs** يتضمن نفس النطاق ومسارات مثل `/reset-password`، `/login`، إلخ.
- **استدعاء Health Check:**
  - إضافة `HEALTH_CHECK_SECRET` في Vercel (إن لم يكن مذكوراً في Part 1).
  - مثال: `GET https://your-app.vercel.app/api/system/health` مع هيدر `x-health-secret: <HEALTH_CHECK_SECRET>` أو `?secret=<HEALTH_CHECK_SECRET>`.
  - التأكد من استجابة `200` و `success: true` في الـ JSON.

المرجع التقني: docs/HEALTH-CHECK.md.

---

## 2. النطاق المخصص (Custom Domain)

- في **Vercel**: Project → **Settings → Domains** → إضافة الدومين (مثل `app.yourdomain.com` أو `yourdomain.com`).
- **DNS**: توجيه السجل حسب تعليمات Vercel (عادةً A أو CNAME). الانتظار حتى يصبح الدومين "Valid" في Vercel.
- **تحديث التطبيق والمصادقة:**
  - في Vercel **Environment Variables**: تغيير `NEXTAUTH_URL` إلى `https://your-domain.com` (بدون `/` في النهاية).
  - في **Supabase → Authentication → URL Configuration**:
    - **Site URL** = `https://your-domain.com`
    - **Redirect URLs**: إضافة `https://your-domain.com`, `https://your-domain.com/reset-password`, `https://your-domain.com/login`, إلخ.
  - تنفيذ **Redeploy** للمشروع على Vercel بعد تغيير `NEXTAUTH_URL`.
- إن كان المشروع يستخدم **CSP** في next.config.js: التأكد من أن النطاق الجديد لا يحتاج إضافة مصدر جديد (عادةً لا يلزم إن كان الموقع يُخدم من نفس النطاق).

---

## 3. المراقبة (Monitoring)

- **Health Check للتوفر (Uptime):**
  - توثيق استخدام `/api/system/health` مع `HEALTH_CHECK_SECRET` من:
    - **Vercel Cron** (إن رغب المستخدم): إضافة مسار في vercel.json لاستدعاء الـ health بشكل دوري (مثلاً كل 5 دقائق) باستخدام CRON_SECRET أو آلية مشابهة، أو الإشارة إلى أن الخدمات الخارجية يمكنها الاستدعاء.
    - أو **خدمة مراقبة خارجية** (مثل UptimeRobot، Better Uptime): إعطاء مثال الطلب مع الهيدر أو `?secret=` وشرح أن الاستجابة 503 تعني فشل أحد المكونات.
  - الإشارة إلى أن تفاصيل الاستجابة (قاعدة البيانات، Auth، Storage) موثقة في docs/HEALTH-CHECK.md.
- **Vercel Speed Insights:**
  - المشروع يستخدم `@vercel/speed-insights` في app/layout.tsx، والبيانات تظهر في **Vercel Dashboard → المشروع → Speed Insights** بعد النشر (لا إعداد إضافي مطلوب).
- **(اختياري للمستقبل)** الإشارة إلى إمكان إضافة مراقبة أخطاء (مثل Sentry) لاحقاً دون تفصيل تنفيذ الآن.

---

## 4. مكان التوثيق

- **الخيار المفضل:** إضافة قسم **"Part 2: التحقق، النطاق المخصص، والمراقبة"** داخل رفع_على_المنصات.md حتى يبقى دليل النشر في ملف واحد (Part 1 = الرفع والنشر الأولي، Part 2 = ما بعد النشر).
- بنية مقترحة:
  - بعد القسم 4 الحالي ("التحقق بعد النشر") توسيعه بقائمة التحقق أعلاه ثم إضافة الأقسام:
    - **5. النطاق المخصص (Custom Domain)**
    - **6. المراقبة (Health Check + Speed Insights)**

لا حاجة لملف منفصل إلا إذا فضّل المستخدم فصل Part 2 في ملف مثل رفع_على_المنصات_الجزء_الثاني.md.

---

## 5. ملخص التغييرات

| العنصر | الإجراء |
|--------|----------|
| رفع_على_المنصات.md | توسيع قسم "التحقق بعد النشر" + إضافة قسم "النطاق المخصص" + قسم "المراقبة" (Health + Speed Insights). |
| متغيرات البيئة | ذكر HEALTH_CHECK_SECRET في جدول المتغيرات (إن لم يكن موجوداً) مع توضيح أنه اختياري لكن موصى به للمراقبة. |
| الكود | لا تغيير في الكود (لا تعديل في health route أو layout أو middleware). |

لا تغييرات على vercel.json (لا إضافة cron تلقائي) في هذه الخطة؛ يمكن توثيق إمكانية استخدام Vercel Cron أو خدمات خارجية لاستدعاء الـ health فقط.
