# تقرير تحليل إدارة تخزين الملفات (File Storage Management)

تقرير تحليلي لإدارة تخزين الملفات في منصة فكرة: البنية التحتية (محلي / S3 / Cloudinary / Supabase)، عمليات الرفع والتحميل والحذف، التحقق من النوع والحجم، ضغط الصور، والثغرات مع مقترحات تحسين.

---

## 1. تحليل البنية التحتية للتخزين

### 1.1 الخدمة المستخدمة

- **الفعّال حاليًا:** تخزين **محلي (Local)** في المسار `public/uploads/{folder}` — يُستخدم عند عدم وجود إعداد AWS أو Cloudinary (lib/storage.ts).
- **مدعوم في الكود (غير مكتمل):**
  - **AWS S3:** يتحقق من متغيرات البيئة ثم يستدعي uploadToS3 — لكن الدالة تُرجع uploadToLocal مع تحذير "S3 upload not implemented yet".
  - **Cloudinary:** نفس الحال، غير مُنفّذ ويُرجع local.
- **Supabase Storage:** لا يُستخدم لرفع أو تحميل الملفات في التطبيق. يظهر فقط في health route كفحص تشخيصي (listBuckets) — لا buckets مخصّصة للمخططات ولا سياسات RLS لملفات التطبيق.

### 1.2 الـ Buckets والسياسات

- **تخزين محلي:** الملفات تحت `public/uploads/plans/` — تُقدّم كملفات **ثابتة** من نفس النطاق؛ الرابط `/uploads/plans/{uuid}.ext` **عام (Public)** (لا توجد حماية على مستوى الملف نفسه).
- **S3/Cloudinary:** غير مفعّلين؛ عند التفعيل لاحقًا يجب تعريف سياسات الوصول (مثلاً S3: private bucket + signed URLs).
- **Supabase Storage:** لا توجد buckets مخصّصة لملفات المخططات.

### 1.3 ضمان أن المستخدم يرى ملفاته فقط

- **على مستوى API:** الرفع يتطلب requireEngineerOrAdmin والتحقق من أن المهندس معيّن للطلب؛ التحميل يتطلب requireAuth والتحقق من عميل/مهندس/أدمن للطلب؛ حذف مخطط نفس التحقق.
- **ضعف:** الرابط (fileUrl) يُعاد في استجابة تفاصيل الطلب للمخوّلين فقط؛ لكن الرابط نفسه غير موقع. في التخزين المحلي، من يملك الرابط يمكنه فتح `/uploads/plans/{uuid}.ext` مباشرة دون مسار التحميل المحمي — لأن الملف يُخدم من public/.

---

## 2. إجراءات معالجة الملفات (File Operations)

### 2.1 دالة الرفع (Upload)

- **الموقع:** app/api/plans/upload/route.ts يستدعي lib/storage.ts uploadFile(file, options).
- **التحقق من النوع (MIME):** allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'] في المسار وفي uploadFile. **تحذير:** الاعتماد على file.type من الطلب قابل للتزوير؛ لا تحقق من magic bytes على السيرفر.
- **الحجم الأقصى:** 10MB عند الرفع؛ 5MB بعد الحفظ — إن تجاوز يُحذف الملف ويُرفض الطلب.

### 2.2 آلية التسمية (File Naming)

- في lib/storage.ts: اسم الملف على القرص = randomUUID() + امتداد من اسم الملف الأصلي — أسماء فريدة تقلل التصادم. fileName في النتيجة للعرض هو الاسم الأصلي.

### 2.3 ربط الملف بقاعدة البيانات

- **الجدول:** Plan في prisma/schema.prisma: fileUrl, fileType, fileName, fileSize, orderId. بعد uploadFile يتم إنشاء سجل Plan بـ fileUrl: uploadResult.url.

---

## 3. الأداء والتحسين (Optimization)

### 3.1 تصغير حجم الصور (Image Compression)

- **موجود:** lib/imageCompression.ts — browser-image-compression (maxSizeMB: 2، maxWidthOrHeight: 1920، quality: 0.8)؛ يتخطى الملفات تحت 500KB. يُستخدم في engineer/orders/[id]/page.tsx قبل الرفع للملفات من نوع صورة فقط. PDF لا يُضغط.

### 3.2 استخدام CDN

- **الحالي:** لا يوجد CDN. عند تفعيل S3 أو Cloudinary يمكن استخدام CloudFront أو CDN Cloudinary.

### 3.3 آلية الحذف (Cleanup)

- **عند حذف Plan (DELETE /api/plans/[planId]):** إن fileUrl يبدأ بـ `/` يتم unlink؛ إن URL سحابي لا يُحذف الملف — تحذير فقط.
- **عند Cron (purge الأرشيف):** يحدّث الخطط بـ purgedAt و fileUrl: '' **دون حذف الملف الفعلي من القرص** — ملفات يتيمة تبقى على التخزين.

---

## 4. جدول الثغرات والمخاطر

| # | النوع | الوصف | الأولوية |
|---|--------|--------|----------|
| 1 | روابط عامة للملفات المحلية | الملفات تحت public/uploads/ قابلة للوصول المباشر؛ من يحصل على الرابط يمكنه التحميل دون مسار التحميل المحمي. | عالية |
| 2 | عدم حذف الملفات الفعلية عند Purge | Cron يحدّث DB فقط ولا يحذف الملف من القرص — استهلاك مساحة وملفات يتيمة. | عالية |
| 3 | عدم حذف الملفات السحابية عند حذف Plan | عند S3/Cloudinary، حذف السجل لا يحذف الملف؛ الكود يسجّل تحذيرًا فقط. | متوسطة |
| 4 | التحقق من MIME يعتمد على العميل | file.type قابل للتزوير؛ لا تحقق من magic bytes على السيرفر. | متوسطة |
| 5 | عدم وجود سياسات تخزين لـ Supabase | Supabase Storage غير مستخدم لملفات التطبيق؛ إن تم الاعتماد عليه تحتاج buckets و RLS. | منخفضة |

---

## 5. كود مقترح لتحسين الرفع والمعالجة

### 5.1 حذف الملف الفعلي عند Purge (Cron)

في app/api/cron/purge-archived-plans/route.ts، قبل تحديث كل plan استدعاء دالة حذف: إذا plan.fileUrl.startsWith('/') فحذف من المسار المحلي (نفس منطق DELETE plan)؛ إن كان URL سحابي استدعاء الدالة المناسبة عند تفعيل S3/Cloudinary. يمكن توسيع deleteFileByUrl في lib/storage.ts لدعم السحابة.

### 5.2 التحقق من نوع الملف على السيرفر (Magic Bytes)

إضافة تحقق في مسار الرفع: قراءة أول بايتات ومقارنتها بتوقيعات (PDF: %PDF، JPEG: FF D8 FF، PNG: 89 50 4E 47). عدم التطابق مع MIME المُعلن → رفض الطلب.

### 5.3 عدم تقديم الملفات من public (تخفيف تسريب الروابط)

تخزين الملفات خارج public/ (مثلاً uploads/ في جذر المشروع) وتقديمها **فقط** عبر مسار التحميل المحمي (GET .../download) الذي يقرأ من القرص ويردّ بـ Response(buffer). يتطلب تعديل uploadToLocal و route التحميل.

---

## 6. خلاصة

- **البنية الحالية:** تخزين محلي في public/uploads/plans/ مع دعم مُجهّز (غير منفّذ) لـ S3 و Cloudinary؛ Supabase Storage فقط لفحص buckets في health.
- **نقاط القوة:** تحقق MIME والحجم، أسماء فريدة (UUID)، ضغط صور في المتصفح، ربط Plan بـ fileUrl، وتحقق صلاحيات على الرفع/التحميل/الحذف.
- **نقاط الضعف الرئيسية:** وصول عام للملفات المحلية عبر URL المباشر، عدم حذف الملفات الفعلية عند purge، عدم حذف الملفات السحابية عند حذف السجل، والاعتماد على MIME من العميل فقط.
