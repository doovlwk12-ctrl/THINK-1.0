# حل نظام المحادثة — خطأ 500

هذا الدليل مستخلص من [تقرير فحص نظام المحادثة](CHAT-SYSTEM-AUDIT-REPORT.md) ويوفّر حلّاً منظماً قابلاً للتطبيق والتحقق.

---

## المشكلة

- ظهور **خطأ 500 (Internal Server Error)** عند طلب `GET /api/messages/:orderId` (مثلاً من صفحة المحادثة).
- عدم وضوح السبب للمستخدم (رسالة عامة) أو للمطور (غياب تسجيل تفصيلي في السيرفر).

---

## الحل (ملخص تنفيذي)

1. **منع أي رد 500 من مسار الرسائل:** تحويل كل استثناء أو رد 5xx إلى **503** مع رسالة ثابتة للمستخدم ("تعذر تحميل المحادثة..." أو "تعذر إرسال الرسالة...").
2. **استخراج آمن لـ `orderId`:** دعم `context.params` كـ **Promise** (Next.js 15) حتى لا يبقى `orderId` غير معرّف ويسبب سلوكاً غير متوقع.
3. **تسجيل تفصيلي في السيرفر:** طباعة `message`, `code`, `meta`, `name`, و **stack** في الـ catch حتى يمكن تشخيص السبب الحقيقي من سجلات Vercel.
4. **الواجهة الأمامية:** إيقاف الـ polling عند رد **500** أو **503** وعرض رسالة موحدة ("تعذر الاتصال بالخادم. تحقق من الاتصال وأعد المحاولة.") مع زر إعادة المحاولة.

للتفاصيل الكاملة (Prisma، RLS، المصادقة، متغيرات البيئة) راجع [CHAT-SYSTEM-AUDIT-REPORT.md](CHAT-SYSTEM-AUDIT-REPORT.md).

---

## قائمة تحقق (Checklist) لتطبيق الحل

استخدم هذه النقاط للتحقق من أن الحل مطبّق في المشروع:

- [ ] **مسار API:** في `app/api/messages/[orderId]/route.ts` يوجد غلاف **try/catch خارجي** في GET (وفي POST إن أردت نفس مستوى الحماية) يرجع **503** عند أي استثناء.
- [ ] **استخراج orderId:** في نفس الملف، يتم استخراج `orderId` من `context.params` مع دعم الوعد: إذا كان `rawParams.then === 'function'` نستدعي `await rawParams` وإلا نستخدم الكائن مباشرة (GET و POST).
- [ ] **الهوك:** في `hooks/useOrderChat.ts` عند رد **500** أو **503** يتم تعيين `pollingStopped = true` وعرض رسالة "تعذر الاتصال بالخادم. تحقق من الاتصال وأعد المحاولة." (أو ما يعادلها).
- [ ] **متغيرات البيئة:** على Vercel مضبوط `DATABASE_URL` بشكل صحيح (ووضع Transaction مع `?pgbouncer=true` إن لزم).

---

## إذا استمر ظهور 500 بعد النشر

1. **التأكد من النشر:** أن آخر commit (بما فيه التعديلات أعلاه) مُنشَر على Vercel. إعادة **Deploy** إذا لزم.
2. **السجلات:** في لوحة Vercel → المشروع → Logs (أو Functions)، ابحث عن **`[messages GET]`** أو **`[messages POST]`** لرؤية رسالة الخطأ و `code` و **stack** الحقيقية.
3. **الاتصال بقاعدة البيانات:** التحقق من أن **DATABASE_URL** على Vercel صحيح (رابط Postgres، كلمة المرور، واستخدام Pooler/Transaction إذا مطلوب).

---

## مرجع سريع للملفات

| الملف | الدور |
|--------|--------|
| `app/api/messages/[orderId]/route.ts` | GET/POST للرسائل؛ تحويل 5xx → 503، تسجيل تفصيلي، استخراج آمن لـ orderId. |
| `hooks/useOrderChat.ts` | جلب الرسائل، polling، إيقاف عند 500/503، إعادة المحاولة. |
| `docs/CHAT-SYSTEM-AUDIT-REPORT.md` | التقرير الكامل (مسار الطلب، Prisma، RLS، المصادقة، الواجهة، Env). |
