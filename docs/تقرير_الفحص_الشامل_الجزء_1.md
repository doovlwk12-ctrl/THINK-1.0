# Part 1: Deep Holistic Audit Report (تقرير الفحص الشامل — الجزء 1)

**النطاق:** تحليل كامل للمشروع (Next.js 14، Prisma/PostgreSQL، Supabase Auth، Vercel).  
**الأدوار:** محلل أنظمة ومعماري برمجيات.

---

## 1. فهم المشروع (من الصفر للنهاية)

- **المنتج:** منصة فكرة — منصة تخطيط معمارية تربط العملاء بالمهندسين لطلبات تصميم فلل/قطع أراضٍ.
- **التقنيات:** Next.js 14 (App Router)، Prisma 5 (PostgreSQL)، Supabase (Auth؛ DB قد يكون Supabase Postgres أو أي PostgreSQL). اختياري: NextAuth، Firebase. النشر: Vercel.
- **التدفق:** العميل يختار باقة → يملأ نموذج الطلب متعدد الخطوات → يُنشأ الطلب (PENDING) → المهندس يبدأ العمل (IN_PROGRESS، معيّن) → رفع/إرسال المخططات (COMPLETED) → العميل يطلب تعديلات أو يؤكد (CLOSED) → أرشفة/إغلاق تلقائي؛ حذف المخططات بعد 45 يوماً عبر cron.

---

## 2. تحليل سير العمل (رحلة المستخدم)

- **العميل:** تسجيل/دخول → لوحة التحكم → اختيار باقة → إنشاء طلب (5 خطوات) → تفاصيل الطلب → محادثة، تعديلات، دفع، إكمال.
- **المهندس:** دخول → لوحة التحكم → قائمة الطلبات → بدء طلب / رفع مخططات / إرسال للعميل / معالجة طلبات التعديل.
- **الأدمن:** إحصائيات، قائمة الطلبات، المهندسين (طلبات الانضمام، دعوة)، باقات CRUD، إعدادات (دبابيس، شراء تعديلات)، محتوى الصفحة الرئيسية.
- **العام:** الصفحة الرئيسية، تسجيل الدخول، التسجيل، نسيت كلمة المرور، تقديم مهندس. API عام: packages، content/homepage، auth/register، auth/forgot-email.

---

## 3. أدوار المستخدمين والصلاحيات (Auth)

- **الأدوار:** CLIENT، ENGINEER، ADMIN (مخزنة في Prisma User.role).
- **مصادر المصادقة:** lib/getApiAuth.ts — Supabase (أساسي عند USE_SUPABASE_AUTH)، ثم جلسة NextAuth. مسار Supabase: إنشاء User في Prisma عند أول دخول إن لم يكن موجوداً.
- **حراس API:** lib/requireAuth.ts — requireAuth، requireRole، requireAdmin، requireEngineerOrAdmin، requireClient. مسارات الطلب/الرسالة/المخطط تتحقق أيضاً من clientId / engineerId.
- **Middleware:** عند Supabase: getSupabaseSession؛ عند NextAuth: withAuth. إعادة توجيه: /admin/* → ADMIN فقط؛ /engineer/* (ما عدا apply) → ENGINEER أو ADMIN؛ /orders/* → المهندس يُوجّه للوحة المهندس.

---

## 4. دورة حياة الطلب (State Machine)

- **الحالات:** PENDING → IN_PROGRESS → REVIEW → COMPLETED → CLOSED؛ فرع جانبي ARCHIVED. lib/orderStateMachine.ts يحدد ALLOWED_TRANSITIONS لكل فاعل.
- **التنفيذ:** app/api/engineer/orders/[id]/status/route.ts يستخدم validateTransition؛ lib/orderAuditLog.ts يسجّل status_change.
- **بدء الطلب:** start/route.ts يضع IN_PROGRESS و engineerId (بدون فحص state machine by design).
- **إرسال المخططات:** plans/send — transaction: تعطيل كل المخططات، تفعيل المختارة، تعيين الطلب COMPLETED و completedAt.
- **إنشاء تعديل:** revisions/create — requireClient، تحقق (pins، remainingRevisions، إلخ)، transaction ينشئ طلب التعديل ويُنقص remainingRevisions ويضع الطلب IN_PROGRESS.
- **إكمال (عميل):** orders/[id]/complete — requireClient + فحص order.clientId؛ يضع CLOSED.

---

## 5. نظام المحادثة

- **API:** GET/POST app/api/messages/[orderId]/route.ts — التحقق: ADMIN أي طلب؛ ENGINEER إذا order.engineerId === auth.userId؛ وإلا CLIENT إذا order.clientId === auth.userId.
- **الواجهة:** است轮询 كل 3 ثوانٍ في صفحات المحادثة (عميل ومهندس).
- **الوقت الحقيقي:** لا WebSockets ولا Supabase Realtime؛ است轮询 فقط.

---

## 6. إدارة الملفات (رفع، تحميل، استلام)

- **الرفع:** app/api/plans/upload/route.ts — requireEngineerOrAdmin، فحص ملكية الطلب، نوع الملف (صورة/PDF)، 10MB؛ lib/storage.ts → محلي أو S3/Cloudinary حسب env. بعد الحفظ: إن تجاوز 5MB يُحذف الملف ويُرجع 413.
- **التحميل:** app/api/orders/[id]/plans/[planId]/download/route.ts — requireAuth، فحص الوصول للطلب، المخطط تابع للطلب.
- **استلام المخططات:** "إرسال المخططات" (plans/send) يفعّل المخططات المختارة ويضع الطلب COMPLETED وإشعار + رابط واتساب اختياري.
- **Vercel:** التخزين المحلي يرمي STORAGE_NOT_CONFIGURED؛ للإنتاج مطلوب S3 أو Cloudinary.

---

## 7. منطق التعديلات (المراجعات)

- **النموذج:** RevisionRequest (orderId، planId، pins JSON، status). الإنشاء: requireClient، Zod لـ pins، تحقق من الطلب و remainingRevisions؛ transaction ينشئ الطلب ويُنقص العدد ويضع الطلب IN_PROGRESS ويُشعر المهندس.
- **القائمة والتفاصيل:** GET revisions/[orderId] و revisions/detail/[revisionId]. المهندس: صفحة revision/[revisionId] لعرض الدبابيس وتنفيذ التعديل ورفع مخطط جديد.

---

## 8. الدبابيس والرسائل

- **الدبابيس:** مخزنة في RevisionRequest.pins كـ JSON. عرض نقاط التعديل في المحادثة: lib/parseModificationPointMessage.ts و components/chat/ModificationPointMessage.tsx.

---

## 9. المنطق شبه الفوري (است轮询 فقط)

- **است轮询:** محادثة كل 3 ثوانٍ؛ إشعارات كل 10 ثوانٍ؛ مؤقت التسجيل؛ CreateOrderContent لفترة حفظ/حالة محلية.
- **Supabase:** onAuthStateChange لتجديد الجلسة فقط؛ لا Realtime للرسائل أو الطلبات.

---

## 10. تحديثات حالة الطلب (شراء تعديلات، دبابيس، انتقالات)

- **انتقالات الحالة:** عبر status/route.ts (state machine + audit + إشعارات للعميل).
- **شراء تعديلات:** buy-revisions — requireClient، ملكية الطلب، RevisionsPurchaseConfig؛ يزيد remainingRevisions.
- **شراء تمديد:** buy-extension — requireClient؛ يمدد الموعد النهائي؛ قد ينقل ARCHIVED → IN_PROGRESS.
- **شراء دبابيس:** buy-pin-pack — requireAuth، وصول للطلب؛ سجل PinPackPurchase.
- **إكمال:** complete — العميل يؤكد؛ CLOSED + إشعارات.

---

## 11. التوافق بين الوحدات (طلب، محادثة، دفع)

- **الطلب ↔ المحادثة:** نفس orderId؛ واجهة الرسائل تتحقق من وصول الطلب.
- **الطلب ↔ المخططات:** المخططات مرتبطة بـ orderId؛ الرفع/الإرسال/التحميل تتحقق من الطلب والدور.
- **الطلب ↔ الدفع:** payments/create — requireAuth، order.clientId === auth.userId؛ idempotency key؛ transaction ينشئ/يحدّث Payment.
- **الطلب ↔ التعديلات:** إنشاء التعديل يستخدم orderId، planId، remainingRevisions؛ إشعارات للمهندس.
- **الإشعارات:** lib/notifications.ts — إشعارات داخل التطبيق (Prisma)؛ اختياري push.

---

## 12. لوحة الإدارة

- **المسارات:** كلها تحت /admin/* و /api/admin/*. الـ middleware يوجّه غير ADMIN إلى /dashboard. API تستخدم requireAdmin.
- **الميزات:** إحصائيات، قائمة الطلبات، طلبات انضمام المهندسين (قائمة، موافقة، رفض)، دعوة، باقات CRUD، إعدادات (دبابيس، شراء تعديلات)، محتوى الصفحة الرئيسية. الأدمن يمكنه تغيير حالة الطلب عبر مسار status (requireEngineerOrAdmin).

---

## 13. مراجعة واجهة المستخدم (مكونات)

- **التخطيط:** Header، ThemeToggle، UserMenu، BackButton. مشترك: Button، Card، Input، Loading. مقدمون: AuthProvider، SupabaseAuthProvider، SessionProvider، ThemeProvider، ProfileDisplayNameProvider، ErrorBoundaryProvider. محادثة: ModificationPointMessage. إشعارات: NotificationBell. خطأ: ErrorBoundary.

---

## 14. الاستجابة (Tailwind)

- استخدام بادئات sm:, md:, lg:, xl: في الصفحات؛ أهداف لمس مناسبة، تباعد، كسر كلمات، min-w-0 في حاويات flex؛ أزرار CTA بعرض كامل على الشاشات الصغيرة.

---

## 15. هيكل قاعدة البيانات

- **المخطط:** Prisma — User، Package، Order، OrderAuditLog، Plan، Message، Payment، PaymentIdempotency، RevisionRequest، Notification، PinPackConfig، RevisionsPurchaseConfig، PinPackPurchase، EngineerApplication، HomepageContent. فهارس على FKs و status و orderNumber و createdAt و deadline و (status+createdAt) إلخ.
- **RLS:** التطبيق يستخدم Prisma فقط؛ التفويض في طبقة API. لا سياسات RLS في Supabase مُشار إليها في الكود.

---

## 16. المصادقة ومعالجة الجلسة/الرمز

- **الجلسة:** Supabase: كوكيز؛ NextAuth: session. الـ middleware يعمل على المسارات المحمية ويفرض تسجيل الدخول.
- **الرموز:** جانب الخادم فقط (getApiAuth، requireAuth). لا رموز في تخزين العميل؛ Supabase/NextAuth يتعاملان مع الجلسة بالكوكيز.
- **المصداقية:** الدور مخزن في Prisma User؛ مزامن من Supabase عند أول دخول.

---

## 17. عمليات التخزين (ضغط، حدود، buckets)

- **الحدود:** 10MB لكل ملف عند الرفع؛ 5MB أقصى بعد الحفظ؛ أقصى 6 ملفات مخطط لكل طلب. الأنواع المسموحة: image/jpeg, image/png, image/jpg, application/pdf.
- **الضغط:** جانب العميل lib/imageCompression.ts (browser-image-compression)؛ يُستخدم قبل رفع المخطط؛ يتخطى الملفات تحت 500KB.
- **Buckets:** لا buckets Supabase Storage مستخدمة؛ التخزين محلي أو S3/Cloudinary عبر lib/storage.ts.

---

## 18. الخادم والتوصيل (مسارات API، Health)

- **مسارات API:** 50+ ملف route تحت app/api/: auth، admin، engineer، orders، messages، notifications، plans، revisions، payments، content، cron، system، users، whatsapp. استخدام موحد لـ requireAuth/requireRole و Zod و handleApiError.
- **Health:** app/api/system/health/route.ts — محمي بـ HEALTH_CHECK_SECRET أو أدمن؛ يفحص DB (Prisma)، Auth (Supabase)، Storage (Supabase listBuckets)； يُرجع زمن الاستجابة وحالة كل فحص؛ 200/503.
- **Rate limiting:** صارم لمسارات المصادقة؛ مرن/غير محدود لمسارات الاست轮询 (messages، notifications، my-orders، engineer/orders، plans، revisions، packages، profile، auth/me). lib/rateLimit.ts في الذاكرة.

---

## 19. كفاءة الخوارزميات

- **State machine:** بحث O(1) في خريطة الانتقالات.
- **إنشاء التعديلات:** transaction واحدة؛ لا N+1 في المسار المُختبر.
- **إرسال المخططات:** transaction واحدة (updateMany للمخططات + تحديث الطلب).
- **مسارات القوائم:** استخدام include (طلب مع عميل، مهندس، باقة) مقبول للوحة التحكم والقوائم. لا أدلة على O(n²) أو حلقات غير محدودة في المسارات الحرجة.
- **محادثة العميل:** است轮询 كل 3 ثوانٍ؛ قائمة الرسائل تُستبدل في الحالة (محدودة باستجابة الخادم).

---

## ملخص الجدول (Part 1)

| # | المجال | الحالة |
|---|--------|--------|
| 1 | فهم المشروع | موثق، واضح من الصفر للنهاية |
| 2 | تحليل سير العمل | رحلات العميل/المهندس/الأدمن مُحددة |
| 3 | الأدوار والصلاحيات | تدفقات المصادقة وحراس API متسقة |
| 4 | دورة حياة الطلب | State machine + سجل تدقيق مُطبّقان |
| 5 | نظام المحادثة | قائم على الاست轮询؛ لا Realtime |
| 6 | إدارة الملفات | رفع/تحميل/استلام منفذة؛ Vercel يحتاج S3/Cloudinary |
| 7 | منطق التعديلات | إنشاء، قائمة، تفاصيل، تنفيذ من المهندس |
| 8 | الدبابيس والرسائل | دبابيس في JSON التعديل؛ عرض نقاط التعديل في المحادثة |
| 9 | المنطق شبه الفوري | setInterval فقط (محادثة 3ث، إشعارات 10ث) |
| 10 | تحديثات حالة الطلب | status API، شراء تعديلات/تمديد/دبابيس، إكمال |
| 11 | التوافق بين الوحدات | الطلب/المحادثة/الدفع/المخططات/التعديلات/الإشعارات متوافقة |
| 12 | لوحة الإدارة | requireAdmin؛ إحصائيات، طلبات، مهندسون، باقات، إعدادات، محتوى |
| 13 | هيكل واجهة المستخدم | مكونات مشتركة، مقدمون، ErrorBoundary |
| 14 | الاستجابة | Tailwind استجابة + تحسينات لمس/تجاوز |
| 15 | هيكل قاعدة البيانات | مخطط Prisma وفهارس؛ لا RLS على مستوى التطبيق |
| 16 | الأمان والجلسة | جلسة جانب الخادم؛ الدور في DB |
| 17 | عمليات التخزين | حدود، ضغط عميل، محلي/S3/Cloudinary |
| 18 | API والـ health | مسارات متسقة؛ فحص صحة وحد معدل الطلبات |
| 19 | كفاءة الخوارزميات | State machine O(1)； transactions؛ لا N+1 حرج |
