# خطة فحص وتنظيف مشروع منصة فكرة

خطة منهجية لفحص المشروع ملفاً بملف، الوجهات الأمامية، الخادم، قاعدة البيانات، المصادقة، التقنيات، واجهات API، هيكل المشروع، الخوارزميات، وتشغيل سيرفر تنفيذي لتنظيف المشروع من الشوائب وتقليل الحجم.

---

## المرحلة 1: فحص الملفات ملفاً بملف

### 1.1 قائمة الملفات الأساسية (خارج node_modules)

| المجلد/الملف | الغرض | أولوية الفحص |
|-------------|--------|---------------|
| `app/` | الصفحات ومسارات API (App Router) | عالية |
| `components/` | مكوّنات الواجهة | عالية |
| `lib/` | دوال مشتركة، API، مصادقة، تخزين | عالية |
| `hooks/` | useAuth، useApi | عالية |
| `middleware.ts` + `middleware/` | حماية المسارات وتوجيه المستخدم | عالية |
| `prisma/` | المخطط، الهجرات، البذور | عالية |
| `schemas/` | تحقق Zod (مثلاً userSchema) | متوسطة |
| `types/` | تعريفات TypeScript (next-auth.d.ts) | متوسطة |
| `scripts/` | سكربتات البناء والهجرة | متوسطة |
| `e2e/` | اختبارات Playwright | متوسطة |
| `public/` | ملفات ثابتة (404، index) | منخفضة |
| `next.config.js`, `tailwind.config.js`, `tsconfig.json` | إعدادات المشروع | عالية |

### 1.2 معايير الفحص لكل ملف

- [ ] **الاستيراد**: لا توجد استيرادات لملفات محذوفة (مثل Firebase).
- [ ] **المتغيرات غير المستخدمة**: إما استخدامها أو حذفها أو تسميتها بـ `_`.
- [ ] **الدوال/المكوّنات المصدّرة**: مستخدمة في مكان آخر أو معرّفة للاستخدام المستقبلي.
- [ ] **الأخطاء والتحذيرات**: تشغيل `npm run lint` و `npm run build` ومعالجة النتائج.
- [ ] **الأمان**: عدم كشف أسرار، استخدام `getApiAuth` أو التحقق من الجلسة في مسارات API الحساسة.

---

## المرحلة 2: فحص الوجهات الأمامية (Frontend)

### 2.1 هيكل الصفحات (App Router)

| المسار | الملف | الدور |
|--------|-------|--------|
| `/` | `app/page.tsx` | الصفحة الرئيسية |
| `(auth)/login` | `app/(auth)/login/page.tsx` | تسجيل الدخول |
| `(auth)/register` | `app/(auth)/register/page.tsx` | التسجيل |
| `(auth)/forgot-password` | `app/(auth)/forgot-password/page.tsx` | نسيت كلمة المرور |
| `(auth)/forgot-email` | `app/(auth)/forgot-email/page.tsx` | نسيت البريد |
| `(client)/dashboard` | `app/(client)/dashboard/page.tsx` | لوحة العميل |
| `(client)/dashboard/profile` | `app/(client)/dashboard/profile/page.tsx` | الملف الشخصي |
| `(client)/orders/create` | `app/(client)/orders/create/page.tsx` | إنشاء طلب |
| `(client)/orders/[id]/*` | صفحات الطلب (تفاصيل، دفع، محادثة، مراجعة) | تدفق الطلب |
| `admin/*` | لوحة الإدارة (طلبات، باقات، مهندسين، إعدادات، محتوى) | إدارة المنصة |
| `engineer/*` | لوحة المهندس (طلبات، محادثة، مراجعات، تقديم طلب) | عمل المهندس |

### 2.2 قائمة فحص الواجهة

- [ ] كل صفحة تُحمّل بدون خطأ 404 أو استيراد مفقود.
- [ ] الصفحات المحمية (dashboard، admin، engineer) تُوجّه لـ `/login` عند عدم المصادقة.
- [ ] المكوّنات المشتركة (Header، UserMenu، Button، Input، Card، Loading) تعمل في كل السياقات.
- [ ] دعم RTL والعربية (اتجاه، خط، نصوص).
- [ ] الوضع الليلي/النهاري (ThemeProvider) يعمل.
- [ ] عدم وجود استدعاءات لـ Firebase أو لـ مكوّنات/دوال محذوفة.

---

## المرحلة 3: فحص الخادم (Server)

### 3.1 Middleware

- [ ] `middleware.ts`: يتحقق من الجلسة ويوجّه حسب الدور (عميل/مهندس/مدير).
- [ ] `middleware/auth.ts`: إن وُجد، لا يتعارض مع المصادقة الحالية.

### 3.2 مسارات API (Route Handlers)

| المسار | الملف | الطريقة | الوظيفة |
|--------|-------|---------|---------|
| `/api/auth/[...nextauth]` | `app/api/auth/[...nextauth]/route.ts` | * | NextAuth |
| `/api/auth/register` | `app/api/auth/register/route.ts` | POST | تسجيل مستخدم جديد |
| `/api/auth/forgot-email` | `app/api/auth/forgot-email/route.ts` | POST | تلميح البريد برقم الجوال |
| `/api/users/profile` | `app/api/users/profile/route.ts` | GET/PUT | الملف الشخصي |
| `/api/packages` | `app/api/packages/route.ts` | GET | قائمة الباقات |
| `/api/orders/create` | `app/api/orders/create/route.ts` | POST | إنشاء طلب |
| `/api/orders/my-orders` | `app/api/orders/my-orders/route.ts` | GET | طلبات المستخدم |
| `/api/orders/[id]/*` | عدة route.ts | GET/POST/PUT | تفاصيل طلب، دفع، باقات إضافية، إكمال، خطط |
| `/api/plans/upload` | `app/api/plans/upload/route.ts` | POST | رفع المخططات |
| `/api/messages/*` | رسائل المحادثة | GET/POST | إرسال واستقبال الرسائل |
| `/api/admin/*` | إدارة الباقات، الطلبات، المهندسين، الإعدادات، المحتوى، الإحصائيات | * | لوحة الإدارة |
| `/api/engineer/*` | طلبات المهندس، بدء/تمديد، تقديم طلب | * | لوحة المهندس |
| `/api/revisions/*` | طلبات المراجعة | * | المراجعات |
| `/api/payments/create` | إنشاء دفعة | POST | المدفوعات |
| `/api/notifications/*` | إشعارات واشتراك | * | الإشعارات |
| `/api/content/homepage` | محتوى الصفحة الرئيسية | GET | المحتوى العام |
| `/api/cron/purge-archived-plans` | حذف الملفات المؤرشفة | GET/POST | مهام مجدولة |

### 3.3 قائمة فحص الخادم

- [ ] كل مسار API يتحقق من المصادقة عند الحاجة عبر `getApiAuth(request)`.
- [ ] التحقق من المدخلات (Zod أو غيره) قبل الكتابة في قاعدة البيانات.
- [ ] معالجة الأخطاء عبر `handleApiError` أو نمط موحّد.
- [ ] عدم استدعاء `firebase-admin` أو Firestore.
- [ ] رفع الملفات عبر `lib/storage.ts` (محلي أو S3/Cloudinary) فقط.

---

## المرحلة 4: قاعدة البيانات والقواعد

### 4.1 Prisma

- [ ] `prisma/schema.prisma`: المخطط مطابق لاستخدام المشروع (User، Package، Order، Plan، Message، Payment، إلخ).
- [ ] `DATABASE_URL` في `.env` يشير إلى SQLite (تطوير) أو PostgreSQL (إنتاج) حسب البيئة.
- [ ] تنفيذ `npx prisma generate` و `npx prisma db push` أو `prisma migrate dev` دون أخطاء.
- [ ] `prisma/seed.ts`: يعمل دون أخطاء ويُنشئ بيانات تجريبية إن لزم.

### 4.2 قواعد العمل (منطقياً)

- [ ] حذف المستخدم (إن وُجد) يتعامل مع الطلبات والرسائل (Cascade/SetNull حسب المخطط).
- [ ] الطلبات لها حالات واضحة: PENDING → IN_PROGRESS → REVIEW → COMPLETED/CLOSED، وARCHIVED مع حذف الملفات لاحقاً.
- [ ] المراجعات (RevisionRequest) وعدد المراجعات المتبقية متسقة مع الباقة والشراءات الإضافية.

---

## المرحلة 5: المصادقة (Authentication)

### 5.1 NextAuth

- [ ] `lib/auth.ts`: `authOptions` يعتمد Credentials Provider مع التحقق من البريد/كلمة المرور عبر Prisma وbcrypt.
- [ ] الجلسة تحتوي على `user.id`, `user.role`, `user.name`, `user.email` (وتوسيع النوع في `types/next-auth.d.ts` إن لزم).
- [ ] لا يوجد استخدام لـ Firebase Auth أو Firestore في المصادقة.

### 5.2 حماية المسارات

- [ ] الصفحات تحت `(client)/dashboard`, `admin`, `engineer` محمية عبر Middleware أو التحقق من الجلسة في الصفحة.
- [ ] مسارات API التي تحتاج مستخدماً تستدعي `getApiAuth(request)` وتتحقق من `auth.role` عند الحاجة (مثلاً ADMIN فقط).

---

## المرحلة 6: التقنيات المستخدمة

### 6.1 القائمة المرجعية

| الفئة | التقنية | الإصدار/ملاحظات |
|-------|---------|------------------|
| الإطار | Next.js | 14.x (App Router) |
| الواجهة | React | 18.x |
| اللغة | TypeScript | 5.x |
| التنسيق | Tailwind CSS | 3.x |
| قاعدة البيانات | Prisma | 5.x |
| قاعدة البيانات | SQLite (تطوير) / PostgreSQL (إنتاج) | حسب .env |
| المصادقة | NextAuth | 4.x |
| النماذج | React Hook Form + Zod + @hookform/resolvers | - |
| الإشعارات | react-hot-toast | - |
| الأيقونات | lucide-react | - |
| الاختبار | Vitest (وحدة)، Playwright (E2E) | - |
| أدوات | ESLint، tsx، prisma | - |

### 6.2 فحص التبعيات

- [ ] `npm install` ينتهي دون أخطاء.
- [ ] لا توجد حزم Firebase أو Firestore في `package.json`.
- [ ] الحزم المهملة (deprecated) معروفة ومقبولة أو مخطوط لاستبدالها لاحقاً.

---

## المرحلة 7: واجهات API (API)

### 7.1 العميل (lib/api.ts)

- [ ] `api()`, `apiPostFormData()`, `apiClient.get/post/put/postFormData/delete` تستخدم `credentials: 'include'` للجلسة.
- [ ] الأساس هو `/api` على نفس النطاق (لا استدعاء Cloud Functions أو نطاق خارجي للمصادقة).
- [ ] التعامل مع الأخطاء والانتهاء (timeout) والاعادة (retry) واضح.

### 7.2 توثيق API

- [ ] مراجعة `API.md` إن وُجد وتحديثه ليتوافق مع المسارات الفعلية بعد إزالة Firebase.
- [ ] توثيق أي مسار يحتاج صلاحيات خاصة (مثل ADMIN فقط).

---

## المرحلة 8: تنظيم هيكل المشروع

### 8.1 الهيكل الحالي (مختصر)

```
app/
  (auth)/          # تسجيل دخول، تسجيل، نسيت كلمة المرور/البريد
  (client)/        # لوحة العميل، الطلبات، الملف الشخصي
  admin/           # لوحة الإدارة
  engineer/        # لوحة المهندس
  api/             # مسارات API (admin, auth, content, cron, engineer, messages, orders, packages, payments, plans, revisions, settings, users, whatsapp)
  layout.tsx, page.tsx, globals.css, not-found.tsx
components/        # shared, layout, providers, chat, notifications, icons
lib/               # api, auth, storage, prisma, getApiAuth, errors, utils, ...
hooks/            # useAuth, useApi
middleware.ts, middleware/
prisma/            # schema, migrations, seed
schemas/           # userSchema
types/             # next-auth.d.ts
scripts/           # check-routes, migrations, ensure-homepage-content-table, ...
e2e/              # playwright
public/
```

### 8.2 توصيات الهيكل

- [ ] الإبقاء على تجميع الصفحات حسب الدور: `(auth)`, `(client)`, `admin`, `engineer`.
- [ ] الإبقاء على فصل واضح: `app/api` للخادم، `components` للواجهة، `lib` للمنطق المشترك.
- [ ] عدم وضع ملفات تنفيذية أو سكربتات عامة داخل `app/`؛ الإبقاء عليها في `scripts/` أو الجذر.

---

## المرحلة 9: الخوارزميات والمنطق الحرج

### 9.1 مناطق تركز الفحص

- [ ] **إنشاء الطلب**: حساب الموعد النهائي (executionDays)، عدد المراجعات، ربط الباقة والعميل.
- [ ] **المراجعات**: خصم مراجعة عند طلب مراجعة، ربط مع شراء مراجعات إضافية وباقة الدبابيس.
- [ ] **الدفع**: ربط الدفعات بالطلب (Payment)، عدم دفع مكرر غير مقصود.
- [ ] **رفع المخططات**: التحقق من الحجم والنوع، الضغط (imageCompression) إن وُجد، حفظ عبر `storage.ts`.
- [ ] **حذف الملفات المؤرشفة**: منطق 45 يوماً و`plansPurgedAt` و`archivedWarningSentAt` في cron.
- [ ] **الرسائل**: ربط الرسائل بالطلب والمرسل، وربما الإشعارات.

### 9.2 الأداء

- [ ] استعلامات Prisma: استخدام `select`/`include` المناسب لتقليل البيانات المُحمّلة.
- [ ] عدم تنفيذ استعلامات ثقيلة داخل حلقات؛ استخدام علاقات أو تجميع حيث أمكن.

---

## المرحلة 10: سيرفر/سكربت التنظيف وتقليل الحجم

### 10.1 أهداف التنظيف

1. حذف الملفات والمجلدات غير المستخدمة.
2. تقليل حجم المستودع (حذف تقارير وملفات مؤقتة ووثائق قديمة).
3. إزالة استيرادات ومتغيرات ميتة.
4. توحيد تنسيق الكود إن أمكن (مثلاً عبر ESLint/Prettier).

### 10.2 عناصر مقترحة للتنظيف

| العنصر | الإجراء المقترح |
|--------|------------------|
| مجلد `.firebase/` | حذف (لم يعد هناك Firebase Hosting) |
| مجلد `playwright-report/` | إضافته إلى `.gitignore` وحذفه من التتبع أو حذفه بعد كل تشغيل E2E |
| مجلد `test-results/` | إضافته إلى `.gitignore` وحذفه من التتبع |
| مجلد `functions/` (إن بقي فارغاً أو بملفات قديمة) | حذف إن لم يعد مستخدماً |
| ملفات `.md` الزائدة في الجذر | دمج أو أرشفة أو حذف (انظر 10.3) |
| `node_modules` | عدم رفعه إلى Git؛ استخدام `npm ci` عند الحاجة |
| `.next` | عدم رفعه؛ يُنشأ عند `npm run build` |
| ملفات `*.log` في `.cursor/` | إضافتها إلى `.gitignore` أو حذفها دورياً |

### 10.3 تنظيم ملفات التوثيق (.md)

- **الاحتفاظ**: `README.md`, `QUICK_START.md`, `API.md`, `ARCHITECTURE.md`, `.env.example`, وربما `CHANGELOG.md`, `ROUTING_GUIDELINES.md`.
- **مراجعة/أرشفة**: وثائق التصميم (DESIGN_*.md) ووضعها في مجلد مثل `docs/design/` أو حذف المكرر.
- **حذف أو أرشفة**: وثائق Firebase (FIREBASE_*.md, FIRESTORE_DESIGN.md) بعد إزالة Firebase، وملفات نقطة التحقق القديمة (CHECKPOINT_*, RESTORE_*, UPDATE_SUMMARY_*) إن لم تعد ضرورية.

### 10.4 سكربت تنفيذي للتنظيف (مقترح)

إنشاء سكربت يعمل محلياً (وليس سيرفراً دائماً) لتنفيذ خطوات آمنة:

- حذف مجلدات: `.firebase`, `playwright-report`, `test-results`, `.next`.
- إزالة أي مجلد `functions` فارغ أو غير مستخدم.
- التحقق من أن `.gitignore` يتضمن: `node_modules`, `.next`, `.env`, `*.log`, `playwright-report`, `test-results`, `.firebase`.

يمكن تشغيل السكربت يدوياً أو من `package.json` كسكربت مثل `clean` أو `clean:artifacts`.

---

## ترتيب التنفيذ المقترح

1. **المرحلة 1 + 6**: فحص الملفات الأساسية والتقنيات والتبعيات.
2. **المرحلة 4 + 5**: التأكد من قاعدة البيانات والمصادقة (بدون Firebase).
3. **المرحلة 3 + 7**: فحص مسارات API والخادم و`getApiAuth` و`lib/api`.
4. **المرحلة 2**: فحص الصفحات والمكوّنات.
5. **المرحلة 8 + 9**: مراجعة الهيكل والخوارزميات الحساسة.
6. **المرحلة 10**: تشغيل سكربت التنظيف وتقليل الحجم وتنظيم الوثائق.

بعد كل مرحلة: تشغيل `npm run lint` و `npm run build` (و `npm run test:run` إن وُجدت اختبارات) للتأكد من عدم كسر المشروع.
