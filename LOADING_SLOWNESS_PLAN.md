# خطة حل مشكلة "جاري التحميل" والبطء

## 1. وصف المشكلة

- **الأعراض**: شاشة كاملة تظهر "جاري التحميل..." مع دوّار تحميل، وتستمر لفترة طويلة أو لا تختفي.
- **الموقع**: الصفحة الرئيسية (وقد تحدث في صفحات أخرى تعتمد على حالة المصادقة أو جلب البيانات).

## 2. مصدر حالة "جاري التحميل" في الصفحة الرئيسية

في `app/page.tsx` (حوالي السطر 146–156):

```ts
if (status === 'loading') {
  return (
    <div className="min-h-screen ...">
      <div className="animate-spin ..."></div>
      <p>جاري التحميل...</p>
    </div>
  )
}
```

- **`status`** يأتي من **`useAuth()`** (`hooks/useAuth.ts`).
- عند استخدام **Firebase**: `status === 'loading'` عندما يكون **`FirebaseAuthProvider`** لا يزال في حالة `loading === true`.
- عند استخدام **NextAuth**: `status` يأتي من **`useSession().status`** وقد يبقى `'loading'` حتى ينتهي جلب الجلسة.

إذن سبب الشاشة الكاملة "جاري التحميل..." هو **بقاء حالة المصادقة (Auth) في وضع التحميل** وعدم الانتقال إلى `authenticated` أو `unauthenticated`.

## 3. الفرضيات (لماذا يبقى التحميل أو يكون بطيئاً)

| ID | الفرضية | التفاصيل |
|----|---------|----------|
| **H1** | تحميل Auth لا ينتهي أبداً | عند Firebase: `getFirebaseAuth()` يعيد `null` في البداية بينما `isFirebaseAuthEnabled() === true`، أو `onAuthStateChanged` لا يُستدعى. عند NextAuth: جلب الجلسة يفشل أو يتأخر دون تحديث الحالة. |
| **H2** | تهيئة Firebase أو الشبكة بطيئة | تحميل SDK أو الاتصال بـ Firebase يستغرق وقتاً طويلاً، فيبقى `loading === true`. |
| **H3** | قراءة الدور من Firestore بطيئة أو معلقة | في `FirebaseAuthProvider`، بعد `onAuthStateChanged` يتم استدعاء `getRoleForUser(uid)` (قراءة من Firestore). حتى تنتهي هذه القراءة لا يُستدعى `setLoading(false)`، فالبطء أو التعطل هنا يطيل "جاري التحميل". |
| **H4** | عدم وجود مهلة زمنية (timeout) | إذا تعلّق أي خطوة (Auth أو Firestore)، لا يوجد fallback يضع `loading = false` بعد مدة معقولة، فيبقى المستخدم على الشاشة نفسها. |
| **H5** | الصفحة الرئيسية تعتمد كلياً على Auth | الصفحة الرئيسية لا تُعرض إلا بعد انتهاء تحميل المصادقة؛ للزائر غير المسجّل هذا يبدو كشاشة تحميل طويلة أو لا تنتهي. |

## 4. خطة الأدلة (Instrumentation) للتشخيص

لتأكيد أي فرضية نستخدم تسجيلات تشخيصية:

1. **`components/providers/FirebaseAuthProvider.tsx`**
   - عند بدء الـ effect: هل `isFirebaseAuthEnabled()` وهل `getFirebaseAuth()` غير null.
   - عند استدعاء `onAuthStateChanged`: تسجيل "onAuthStateChanged fired" ووجود/عدم وجود `user`.
   - قبل وبعد `getRoleForUser(user.uid)`: وقت البداية والنهاية (أو نجاح/فشل).
   - عند كل `setLoading(false)` أو `setLoading(true)`: تسجيل القيمة والموقع (لماذا تغيّرت).

2. **`app/page.tsx`**
   - عند عرض شاشة "جاري التحميل...": تسجيل `status` وقيمة `useAuth()` (مثلاً من مصدر Firebase أو NextAuth).

3. **`hooks/useAuth.ts`**
   - عند إرجاع الحالة: تسجيل `status` و (عند Firebase) قيمة `loading` من الـ provider.

بعد إضافة هذه التسجيلات وإعادة تنفيذ السيناريو (فتح الصفحة الرئيسية وانتظار التحميل)، نقرأ السجلات لنحدد:
- هل الـ loading يُرفع بعد وقت معقول؟
- أي خطوة (تهيئة Auth، onAuthStateChanged، getRoleForUser) تتأخر أو لا تنفّذ؟

## 5. الإجراءات المقترحة (حسب الأدلة)

- **إذا تأكد H1/H2 (Auth أو التهيئة لا تكتمل)**  
  - التحقق من إعدادات Firebase (المتغيرات في `.env`، الشبكة، القواعد).  
  - إضافة **timeout** في الـ provider: بعد 5–8 ثوانٍ من بدء التحميل، استدعاء `setLoading(false)` حتى لا تبقى الشاشة معلقة للأبد.

- **إذا تأكد H3 (getRoleForUser بطيء/معلق)**  
  - تخفيف الاعتماد على القراءة الأولى: مثلاً عرض الواجهة أولاً بحالة "زائر" ثم تحديث الدور عند وصوله (لا حجب كل الصفحة).  
  - تحسين الاستعلام (فهرسة، تقليل حجم البيانات).  
  - إضافة timeout لاستدعاء `getRoleForUser` (مثلاً 3–5 ثوانٍ) ثم اعتبار الدور افتراضي (مثل CLIENT) و`setLoading(false)`.

- **إذا تأكد H4 (لا timeout)**  
  - تنفيذ timeout في `FirebaseAuthProvider`: مؤقت واحد يبدأ مع تفعيل تحميل Auth، وبعد 5–8 ثوانٍ يستدعي `setLoading(false)` إذا كانت الحالة لا تزال loading.  
  - التأكد من أن جميع المسارات (نجاح، فشل، خطأ) تستدعي `setLoading(false)`.

- **إذا تأكد H5 (الصفحة الرئيسية تعتمد كلياً على Auth)**  
  - **عدم حجب الصفحة الرئيسية على Auth**: عدم عرض شاشة "جاري التحميل..." للصفحة الرئيسية فقط؛ عرض المحتوى (الهيرو، الباقات، إلخ) مباشرة، واستخدام `status === 'loading'` فقط في الأجزاء التي تحتاج جلسة (مثل القائمة أو لوحة التحكم).  
  - أو: عرض الهيكل العام فوراً مع دوّار صغير في الهيدر بدلاً من شاشة كاملة.

## 6. ملخص تنفيذي

| الخطوة | الإجراء |
|--------|---------|
| 1 | إضافة instrumentation في `FirebaseAuthProvider` و`app/page.tsx` و`useAuth` كما في القسم 4. |
| 2 | إعادة إنتاج المشكلة (فتح الصفحة الرئيسية، ربما على شبكة بطيئة أو بدون تسجيل دخول) وجمع السجلات. |
| 3 | تحليل السجلات وتحديد الفرضية المؤكدة (H1–H5). |
| 4 | تطبيق الإجراء المناسب (timeout، عدم حجب الصفحة الرئيسية، تحسين getRoleForUser). |
| 5 | التحقق بعد التعديل وإزالة التسجيلات بعد استقرار الحل. |

## 7. إعادة الإنتاج للتشخيص

1. التأكد من أن المشروع يعمل (`npm run dev`) وأن المتصفح يفتح الصفحة الرئيسية.
2. (اختياري) تقليد شبكة بطيئة من أدوات المطور (DevTools → Network → Slow 3G).
3. تحديث الصفحة أو فتحها في نافذة خاصة (بدون جلسة سابقة).
4. مراقبة المدة التي تبقى فيها "جاري التحميل..." وقراءة السجلات بعد التنفيذ.

---

بعد تنفيذ الخطوات أعلاه وجمع السجلات، يمكن تحديد السبب بدقة وتطبيق الإصلاح المناسب (مع الإبقاء على الـ instrumentation حتى التأكد من نجاح الحل).
