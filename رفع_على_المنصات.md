# رفع منصة فكرة على المنصات

دليل سريع لرفع المشروع على **GitHub** ثم نشره على **Vercel** (أو **Render**).

**ملاحظة:** النشر على المنصات و Supabase **موقوفان مؤقتاً**. للمشروع المحلي فقط راجع [مشروع_محلي_وقف_المنصات.md](مشروع_محلي_وقف_المنصات.md). استخدم هذا الدليل عند استئناف النشر.

---

## 1. رفع الكود على GitHub

```bash
# إن لم يكن المشروع مرفوعاً بعد
git add .
git commit -m "جاهز للنشر"
git branch -M main
git remote add origin https://github.com/YOUR_USERNAME/YOUR_REPO.git
git push -u origin main
```

إذا كان المستودع موجوداً وتريد تحديثه فقط:

```bash
git add .
git commit -m "تحديث قبل النشر"
git push origin main
```

---

## 2. النشر على Vercel (موصى به)

1. ادخل إلى [vercel.com](https://vercel.com) وسجّل الدخول (يفضل عبر GitHub).
2. **Add New…** → **Project**.
3. اختر مستودع المشروع من GitHub (أو **Import** واربط الحساب ثم اختر المستودع).
4. **Project Name:** استخدم أحرفاً صغيرة وأرقاماً وشرطة فقط، مثال: `think-1-0` أو `fekra-platform`.
5. **Framework Preset:** Next.js (يُكتشف تلقائياً).
6. **Environment Variables** — أضف المتغيرات التالية (من **Settings → Environment Variables** أو أثناء إنشاء المشروع):

| المتغير | القيمة | مطلوب |
|---------|--------|--------|
| `DATABASE_URL` | رابط PostgreSQL (Supabase: من Connect → **Transaction**، أضف في النهاية `?pgbouncer=true`) | نعم |
| `NEXTAUTH_SECRET` | سلسلة عشوائية 32+ حرفاً، مثلاً: `openssl rand -base64 32` | نعم |
| `NEXTAUTH_URL` | رابط الموقع بعد النشر، مثال: `https://اسم-المشروع.vercel.app` | نعم |
| `USE_SUPABASE_AUTH` | `true` | عند استخدام Supabase |
| `NEXT_PUBLIC_USE_SUPABASE_AUTH` | `true` | عند استخدام Supabase |
| `NEXT_PUBLIC_SUPABASE_URL` | `https://xxxxx.supabase.co` | مع Supabase |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | المفتاح العام من Supabase → API | مع Supabase |
| `SUPABASE_SERVICE_ROLE_KEY` | مفتاح service_role من Supabase (سري) | موصى به مع Supabase |
| `HEALTH_CHECK_SECRET` | سلسلة عشوائية سرية (لتأمين `/api/system/health`) | اختياري — موصى به للمراقبة |

7. اضغط **Deploy**.
8. بعد انتهاء البناء، حدّث `NEXTAUTH_URL` برابط الموقع الفعلي ثم **Redeploy**.
9. في **Supabase** → **Authentication → URL Configuration**: ضع **Site URL** = رابط Vercel، وأضف في **Redirect URLs** نفس النطاق ومسارات مثل `/reset-password`.

**تطبيق الهجرات على قاعدة الإنتاج (مرة واحدة):**

```bash
# من جهازك (مع .env يحتوي DATABASE_URL للإنتاج)
npx prisma migrate deploy
```

---

## 3. النشر على Render (بديل)

1. من [dashboard.render.com](https://dashboard.render.com): **New +** → **PostgreSQL** لإنشاء قاعدة بيانات، انسخ **Internal Database URL**.
2. **New +** → **Web Service**، اربط مستودع GitHub واختر الفرع (مثل `main`).
3. الإعدادات:
   - **Build Command:** `npm install && npx prisma generate && npm run build`
   - **Start Command:** `npx prisma migrate deploy && npm start`
4. من **Environment** أضف: `DATABASE_URL`، `NEXTAUTH_URL` (رابط الخدمة بعد النشر)، `NEXTAUTH_SECRET`، ومتغيرات Supabase إن استخدمتها.
5. **Create Web Service**.

---

## 4. التحقق بعد النشر (Part 2)

### قائمة التحقق

- [ ] افتح رابط الموقع المنشور وتأكد من تحميل **الصفحة الرئيسية**.
- [ ] جرّب **إنشاء حساب** ثم **تسجيل الدخول**.
- [ ] تأكد من الوصول إلى **لوحة التحكم** (عميل / مهندس / أدمن حسب الدور).
- [ ] (اختياري) إنشاء طلب تجريبي للتأكد من تدفق الطلبات والـ API.

### Supabase

- **Authentication → URL Configuration**: أن **Site URL** = رابط الموقع المنشور (بدون `/` في النهاية).
- **Redirect URLs**: يتضمن نفس النطاق ومسارات مثل `/reset-password`، `/login`.

### Health Check

- أضف `HEALTH_CHECK_SECRET` في Vercel (سلسلة عشوائية سرية) — انظر الجدول في القسم 2.
- استدعاء: `GET https://your-app.vercel.app/api/system/health` مع هيدر `x-health-secret: <HEALTH_CHECK_SECRET>` أو `?secret=<HEALTH_CHECK_SECRET>`.
- تأكد من استجابة **200** و `success: true` في الـ JSON.

تفاصيل الاستجابة والمكونات (قاعدة البيانات، Auth، Storage): راجع [docs/HEALTH-CHECK.md](docs/HEALTH-CHECK.md).

---

## 5. النطاق المخصص (Custom Domain)

1. في **Vercel**: Project → **Settings** → **Domains** → أضف الدومين (مثل `app.yourdomain.com` أو `yourdomain.com`).
2. **DNS**: وجّه السجل حسب تعليمات Vercel (عادةً A أو CNAME). انتظر حتى يصبح الدومين **Valid** في Vercel.
3. **تحديث التطبيق والمصادقة:**
   - في Vercel **Environment Variables**: غيّر `NEXTAUTH_URL` إلى `https://your-domain.com` (بدون `/` في النهاية).
   - في **Supabase → Authentication → URL Configuration**:
     - **Site URL** = `https://your-domain.com`
     - **Redirect URLs**: أضف `https://your-domain.com`، `https://your-domain.com/reset-password`، `https://your-domain.com/login`، إلخ.
   - نفّذ **Redeploy** للمشروع على Vercel بعد تغيير `NEXTAUTH_URL`.
4. إن كان المشروع يستخدم **CSP** في `next.config.js`: عادةً لا تحتاج إضافة مصدر جديد إن كان الموقع يُخدم من نفس النطاق.

---

## 6. المراقبة (Monitoring)

### Health Check للتوفر (Uptime)

- استخدم `/api/system/health` مع `HEALTH_CHECK_SECRET` من:
  - **خدمة مراقبة خارجية** (مثل UptimeRobot، Better Uptime): اضبط طلباً دورياً إلى `https://your-app.vercel.app/api/system/health` مع هيدر `x-health-secret: <HEALTH_CHECK_SECRET>` أو `?secret=<HEALTH_CHECK_SECRET>`. استجابة **503** تعني فشل أحد المكونات (قاعدة البيانات، Auth، أو Storage).
  - أو **Vercel Cron**: يمكن إضافة استدعاء دوري للـ health من `vercel.json` (باستخدام سري أو آلية مشابهة) إن رغبت.
- تفاصيل الاستجابة (قاعدة البيانات، Auth، Storage) موثقة في [docs/HEALTH-CHECK.md](docs/HEALTH-CHECK.md).

### Vercel Speed Insights

- المشروع يستخدم `@vercel/speed-insights` في التطبيق؛ البيانات تظهر في **Vercel Dashboard → المشروع → Speed Insights** بعد النشر. لا إعداد إضافي مطلوب.

### لاحقاً (اختياري)

- يمكن إضافة مراقبة أخطاء (مثل Sentry) لاحقاً لرصد الأخطاء في الإنتاج.

---

للتفاصيل الكاملة (خطأ 503، Pooler، إلخ) راجع [docs/DEPLOYMENT.md](docs/DEPLOYMENT.md) و [DEPLOYMENT.md](DEPLOYMENT.md).
